<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>時光迴廊 - 懷舊音樂之旅</title>
    <style>
        /* CSS樣式與之前相同，此處為節省篇幅省略... */
        /* --- 全局與佈局 --- */
        :root {
            --record-size: 300px;
            --theme-color-1: #ff8c00; /* 溫暖的橙色 */
            --theme-color-2: #483d8b; /* 懷舊的暗藍色 */
            --font-family: 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            overflow: hidden;
            touch-action: none;
            background: linear-gradient(135deg, #2a2a3e, #4a3a4a);
            color: white;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none;
        }
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none; /* 默認全部隱藏 */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            text-align: center;
            box-sizing: border-box;
            padding: 20px;
        }
        .screen.active {
            display: flex;
        }
        .retro-button {
            padding: 12px 28px;
            font-size: 18px;
            color: white;
            background: linear-gradient(145deg, var(--theme-color-1), #e06a00);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 0 #a04a00, 2px 2px 8px rgba(0,0,0,0.5);
            transition: all 0.1s ease-out;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .retro-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #a04a00;
        }
        h1 { font-size: 42px; text-shadow: 2px 2px 8px rgba(0,0,0,0.8); }
        p { opacity: 0.9; }

        /* --- 主選單 (時光迴廊) --- */
        #main-menu-screen {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://source.unsplash.com/random/800x600/?city,night,80s') no-repeat center center/cover;
        }
        #main-menu-screen h1 { font-size: 48px; }
        .game-choice-container { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 30px; }
        .game-choice-card {
            width: 140px;
            height: 180px;
            margin: 15px;
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            background: rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .game-choice-card:hover { transform: scale(1.05); border-color: var(--theme-color-1); }
        .game-choice-card .icon { font-size: 50px; }
        .game-choice-card .title { font-size: 22px; margin-top: 15px; font-weight: bold; }

        /* --- 玩法示範 --- */
        #tutorial-screen .tutorial-container { position: relative; width: 300px; height: 400px; border: 2px dashed #fff; border-radius: 10px; background: rgba(0,0,0,0.2); }
        #tutorial-screen p { margin: 15px 0 25px 0; font-size: 18px; }
        .tutorial-item { position: absolute; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .tutorial-item.active { opacity: 1; }
        .demo-finger {
            width: 40px; height: 40px; background-color: rgba(255, 255, 100, 0.8); border-radius: 50%;
            position: absolute; box-shadow: 0 0 15px white; z-index: 100;
        }
        .demo-note { width: 50px; height: 50px; border-radius: 50%; background: #ffd700; display:flex; justify-content:center; align-items:center; }
        .demo-note-strong { width: 65px; height: 65px; background: #ff4500; }
        .demo-judgment-line { position: absolute; bottom: 50px; width: 80%; height: 3px; background: var(--theme-color-1); border-radius: 3px; }
        @keyframes demo-tap { 0% {transform: scale(1);} 20% {transform: scale(0.8);} 40% {transform: scale(1);} 100% {transform: scale(1);} }
        @keyframes demo-move { from { top: 20%; } to { top: 80%; } }
        @keyframes demo-drag { from { transform: rotate(-30deg); } to { transform: rotate(30deg); } }

        /* --- 歌曲選擇 --- */
        #song-selection-screen { backdrop-filter: blur(10px); }
        #song-list { width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto; padding-top: 10px; }
        .song-choice {
            background-color: rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px;
            padding: 15px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .song-choice:not(.locked):hover { border-color: var(--theme-color-1); transform: scale(1.02); }
        .song-choice.locked { cursor: not-allowed; background-color: rgba(0,0,0,0.5); color: #888; }
        .song-title { font-size: 20px; font-weight: bold; }
        .song-artist { font-size: 14px; opacity: 0.8; margin-top: 5px; }
        .song-highscore, .song-unlock-condition { font-size: 12px; margin-top: 8px; color: var(--theme-color-1); }
        .lock-icon { font-size: 28px; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); opacity: 0.7; }

        /* --- 遊戲通用 UI --- */
        .game-ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; pointer-events: none;
        }
        .game-ui-container.active { display: block; }
        .game-stats {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; font-size: 24px;
            color: white; text-shadow: 1px 1px 3px black; pointer-events: auto;
        }
        .feedback-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 101;
        }
        .feedback {
            font-size: 48px; font-weight: bold;
            opacity: 0; animation: feedback-anim 1s forwards;
        }
        .feedback.perfect { color: #ffd700; }
        .feedback.miss { color: #ff69b4; }
        .first-play-hint {
            position: absolute; background-color: rgba(0,0,0,0.8); padding: 10px 15px; border-radius: 8px;
            color: white; font-size: 16px; pointer-events: none; z-index: 200;
            text-shadow: 1px 1px 2px black;
            animation: pulse 2s infinite;
        }

        /* --- 指揮家 遊戲樣式 --- */
        #conductor-game-area { width: 100vw; height: 100vh; cursor: crosshair; pointer-events: auto; }
        #conductor-game-area .note { position: absolute; width: 50px; height: 50px; border-radius: 50%; transform: translate(-50%, -50%) scale(0); transition: transform 0.3s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.3); border: 2px solid rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; }
        #conductor-game-area .note.active { transform: translate(-50%, -50%) scale(1); background-color: rgba(255, 215, 0, 0.5); border-color: #ffd700; animation: pulse 1.5s infinite; }
        #conductor-game-area .note.strong.active { transform: translate(-50%, -50%) scale(1.3); background-color: rgba(255, 100, 100, 0.7); border-color: #ff4500; }
        #conductor-game-area .note.hold.active::after { content: ''; position: absolute; width: 100%; height: 100%; border: 4px solid #1e90ff; border-radius: 50%; animation: shrink var(--duration) linear forwards; }
        #conductor-game-area .trail { position: absolute; width: 20px; height: 20px; background: radial-gradient(circle, rgba(255, 223, 186, 0.8) 0%, rgba(255, 223, 186, 0) 70%); border-radius: 50%; transform: translate(-50%, -50%); z-index: 5; pointer-events: none; animation: fade-out 0.5s forwards; }

        /* --- 時光唱盤 遊戲樣式 --- */
        #turntable-game-area { width: 100%; height: 100%; display:flex; justify-content:center; align-items:center; }
        #turntable-container { position: relative; width: var(--record-size); height: var(--record-size); }
        #turntable-container #record { width: 100%; height: 100%; background: radial-gradient(circle, #555 10%, #444 11%, #333 12%, #333 100%); border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: spin 10s linear infinite; animation-play-state: paused; }
        #turntable-container #record::before { content: ''; position: absolute; width: 90%; height: 90%; border-radius: 50%; background-image: repeating-radial-gradient(circle, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 1px, transparent 1px, transparent 4px); }
        #turntable-container #record-label { width: 35%; height: 35%; background-color: #d2b48c; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 11px; color: #5d4037; font-weight: bold; z-index: 1; border: 2px solid #a1887f; padding: 5px; box-sizing: border-box; }
        #turntable-container #judgment-zone { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; border: 2px solid rgba(255, 223, 186, 0.7); border-radius: 50%; z-index: 10; background: rgba(255,223,186,0.2); }
        #turntable-container .note { position: absolute; width: 40px; height: 10px; background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.8), transparent); border-radius: 5px; transform-origin: 50% calc(var(--record-size) / 2); top: 50%; left: 50%; margin-top:-5px; margin-left:-20px; z-index: 5; }
        #turntable-container .note.strong { background: linear-gradient(90deg, transparent, rgba(255, 100, 100, 1), transparent); box-shadow: 0 0 10px #ff4500; height: 14px; margin-top:-7px; }

        /* --- 時光節拍 遊戲樣式 --- */
        #timebeat-game-area { width: 100%; height: 100%; pointer-events: auto; }
        #timebeat-game-area #judgment-line-container { position:absolute; bottom: 15%; left:0; width:100%; display:flex; justify-content:center; }
        #timebeat-game-area #judgment-line { width: 90%; max-width: 400px; height: 5px; background: linear-gradient(90deg, transparent, var(--theme-color-1), transparent); box-shadow: 0 0 15px var(--theme-color-1); border-radius: 5px; }
        #timebeat-game-area .note { position: absolute; top: -50px; width: 80px; height: 30px; background: #ffd700; border-radius: 15px; transform: translateX(-50%); transition: top 1.5s linear; }
        #timebeat-game-area .note.strong { background: #ff4500; box-shadow: 0 0 10px #ff4500; height: 40px; }
        
        /* --- 結束與排行榜畫面 --- */
        #end-screen-content { padding: 20px; }
        #leaderboard-screen input {
            width: 100px; font-size: 24px; text-align: center; background: #333; color: white; border: 2px solid #ccc;
            border-radius: 5px; margin: 10px 0; text-transform: uppercase;
        }
        #leaderboard-list { list-style: none; padding: 0; width: 80%; max-width: 350px; margin-top: 20px; }
        #leaderboard-list li {
            display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px;
            background: rgba(255,255,255,0.1); border-radius: 5px;
        }
        #leaderboard-list li:first-child { background: var(--theme-color-1); font-weight: bold; }

        /* --- 動畫 --- */
        @keyframes pulse { 0% { box-shadow: 0 0 10px #ffd700; } 50% { box-shadow: 0 0 25px #ffd700; } 100% { box-shadow: 0 0 10px #ffd700; } }
        @keyframes shrink { from { transform: scale(1.5); opacity: 1; } to { transform: scale(1); opacity: 0; } }
        @keyframes fade-out { to { transform: translate(-50%, -50%) scale(0); opacity: 0; } }
        @keyframes feedback-anim { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="conductor-game-area" class="game-ui-container"></div>
        <div id="turntable-game-area" class="game-ui-container">
            <div id="turntable-container">
                <div id="judgment-zone"></div>
                <div id="record"><div id="record-label"><div class="song-title"></div><div class="song-artist"></div></div></div>
            </div>
        </div>
        <div id="timebeat-game-area" class="game-ui-container">
            <div id="judgment-line-container">
                 <div id="judgment-line"></div>
            </div>
        </div>
        
        <div class="game-stats" style="display: none;">
            <div>得分: <span id="score">0</span></div>
            <div>連擊: <span id="combo">0</span></div>
        </div>
        <div class="feedback-container"></div>
    </div>

    <div id="main-menu-screen" class="screen active">
        <h1>時光迴廊</h1>
        <p>選擇你的懷舊音樂之旅</p>
        <div class="game-choice-container">
            <div class="game-choice-card" data-gametype="conductor">
                <div class="icon">🎼</div>
                <div class="title">指揮家</div>
            </div>
            <div class="game-choice-card" data-gametype="turntable">
                <div class="icon">💿</div>
                <div class="title">時光唱盤</div>
            </div>
            <div class="game-choice-card" data-gametype="timebeat">
                <div class="icon">🎹</div>
                <div class="title">時光節拍</div>
            </div>
        </div>
        <button class="retro-button" id="show-tutorial-btn" style="margin-top: 30px;">觀看玩法</button>
    </div>

    <div id="tutorial-screen" class="screen">
        <h1 id="tutorial-title">玩法示範</h1>
        <p id="tutorial-desc">點擊屏幕繼續</p>
        <div class="tutorial-container">
            </div>
        <button class="retro-button" id="skip-tutorial-btn">略過示範</button>
    </div>

    <div id="song-selection-screen" class="screen">
        <h1 id="song-selection-title">選擇曲目</h1>
        <div id="song-list"></div>
        <button class="retro-button" id="back-to-main-menu-btn">返回主選單</button>
    </div>

    <div id="end-screen" class="screen">
        <div id="end-screen-content">
            <h1 id="end-title">演奏結束</h1>
            <p style="font-size: 24px;">最終得分: <span id="final-score">0</span></p>
            <p>最高連擊: <span id="max-combo">0</span></p>
            <p>評級: <span id="rating-badge"></span></p>
            <button id="view-leaderboard-btn" class="retro-button">查看排行榜</button>
            <button id="retry-button" class="retro-button">再次嘗試</button>
            <button id="back-to-song-menu-btn" class="retro-button">返回選曲</button>
        </div>
    </div>
    
    <div id="leaderboard-screen" class="screen">
        <h1 id="leaderboard-title">歌曲排行榜</h1>
        <div id="name-prompt" style="display: none;">
            <h3>恭喜創下新紀錄！請留下你的大名：</h3>
            <input type="text" id="player-name-input" maxlength="3" value="AAA">
            <button id="submit-score-btn" class="retro-button">提交分數</button>
        </div>
        <ol id="leaderboard-list"></ol>
        <button class="retro-button" id="back-from-leaderboard-btn">返回</button>
    </div>

    <script>
    // =================================================================================
    //  時光迴廊 H5 遊戲 - 統一程式碼框架 (動態載入版)
    // =================================================================================

    // --- 全局 DOM 獲取 ---
    const allScreens = document.querySelectorAll('.screen');
    const gameUIs = document.querySelectorAll('.game-ui-container');
    const gameStatsEl = document.querySelector('.game-stats');
    const feedbackContainer = document.querySelector('.feedback-container');

    // --- 音訊管理器 ---
    const AudioManager = {
        sounds: {},
        bgm: null,
        preload() {
            this.sounds.hit = new Audio('/audio/hit.wav');
            this.sounds.miss = new Audio('/audio/miss.wav');
            
            // 處理瀏覽器音訊自動播放政策
            const initAudio = () => {
                Object.values(this.sounds).forEach(sound => {
                    sound.play().catch(() => {});
                    sound.pause();
                });
                window.removeEventListener('click', initAudio, true);
                window.removeEventListener('touchstart', initAudio, true);
            };
            window.addEventListener('click', initAudio, true);
            window.addEventListener('touchstart', initAudio, true);
        },
        play(soundName) {
            const sound = this.sounds[soundName];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.error("音效播放失敗:", e));
            }
        },
        playBGM(audioFile) {
            this.stopBGM();
            const bgmPath = `/audio/${audioFile}`;
            this.bgm = new Audio(bgmPath);
            this.bgm.loop = true;
            this.bgm.play().catch(e => console.error(`BGM ${bgmPath} 播放失敗:`, e));
        },
        stopBGM() {
            if (this.bgm) {
                this.bgm.pause();
                this.bgm = null;
            }
        }
    };
    
    // --- 遊戲狀態管理器 ---
    const Game = {
        state: { /* ... */ },
        init() { /* ... */ },
        showScreen(screenId) { /* ... */ },
        async startGame(songId) { // *** 改為異步函數 ***
            this.state.currentSongId = songId;
            const gameType = this.state.activeGame;
            const songData = SongData[gameType][songId];
            
            // 顯示讀取中... (可選)
            this.showScreen('loading-screen'); // 假設有一個讀取畫面

            try {
                // 從 /beatmaps/ 動態載入譜面
                const response = await fetch(`/beatmaps/${songData.beatmapFile}`);
                if (!response.ok) throw new Error(`找不到譜面檔案: ${songData.beatmapFile}`);
                const notes = await response.json();

                // 譜面載入成功後，才正式開始遊戲
                this.state.score = 0;
                this.state.combo = 0;
                this.state.maxCombo = 0;
                this.state.isPlaying = true;

                allScreens.forEach(s => s.classList.remove('active'));
                gameUIs.forEach(ui => ui.classList.remove('active'));
                document.getElementById(`${gameType}-game-area`).classList.add('active');
                gameStatsEl.style.display = 'flex';
                this.updateUI();

                // 播放BGM
                AudioManager.playBGM(songData.audioFile);

                // 啟動對應的遊戲邏輯，並傳入譜面
                const GameImplementations = { conductor: Conductor, turntable: Turntable, timebeat: TimeBeat };
                GameImplementations[gameType].start(notes, songData);
                
                // 首次遊玩提示
                if (this.state.isFirstPlay[gameType]) {
                    this.showFirstPlayHint();
                    this.state.isFirstPlay[gameType] = false;
                    localStorage.setItem('isFirstPlay', JSON.stringify(this.state.isFirstPlay));
                }

            } catch (error) {
                console.error("無法開始遊戲:", error);
                alert(`錯誤：無法載入歌曲資源。\n${error.message}`);
                this.showScreen('song-selection-screen'); // 返回選歌畫面
            }
        },
        endGame() { /* ... */ },
        updateUI() { /* ... */ },
        showFeedback(type, text) { /* ... */ },
        showFirstPlayHint() { /* ... */ },
    };
    // 為了節省篇幅，部分未變動的函數內容用 /* ... */ 表示
    Object.assign(Game, {
        state: {
            activeGame: null,
            currentSongId: null,
            score: 0,
            combo: 0,
            maxCombo: 0,
            isPlaying: false,
            isFirstPlay: { conductor: true, turntable: true, timebeat: true },
            gameLoopId: null
        },
        init() {
            document.querySelectorAll('.game-choice-card').forEach(card => {
                card.addEventListener('click', () => {
                    this.state.activeGame = card.dataset.gametype;
                    this.showScreen('song-selection-screen');
                    SongSelection.render();
                });
            });
            document.getElementById('show-tutorial-btn').addEventListener('click', () => Tutorial.start());
            document.getElementById('back-to-main-menu-btn').addEventListener('click', () => this.showScreen('main-menu-screen'));
            document.getElementById('retry-button').addEventListener('click', () => this.startGame(this.state.currentSongId));
            document.getElementById('back-to-song-menu-btn').addEventListener('click', () => {
                this.showScreen('song-selection-screen');
                SongSelection.render();
            });
            document.getElementById('view-leaderboard-btn').addEventListener('click', () => Leaderboard.show());

            const savedFirstPlay = localStorage.getItem('isFirstPlay');
            if (savedFirstPlay) { this.state.isFirstPlay = JSON.parse(savedFirstPlay); }
            this.showScreen('main-menu-screen');
        },
        showScreen(screenId) {
            allScreens.forEach(s => s.classList.remove('active'));
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.add('active');
        },
        endGame() {
            if (!this.state.isPlaying) return;
            AudioManager.stopBGM();
            this.state.isPlaying = false;
            if (this.state.gameLoopId) cancelAnimationFrame(this.state.gameLoopId);
            gameStatsEl.style.display = 'none';

            const songData = SongData[this.state.activeGame][this.state.currentSongId];
            const maxPossibleScore = (songData.noteCount || 1) * 350; // noteCount 應在載入譜面時計算
            const scoreRatio = maxPossibleScore > 0 ? this.state.score / maxPossibleScore : 0;
            let rating = 'C';
            if (scoreRatio >= 0.9) rating = 'S';
            else if (scoreRatio >= 0.8) rating = 'A';
            else if (scoreRatio >= 0.6) rating = 'B';
            
            document.getElementById('end-title').textContent = `《${songData.title}》`;
            document.getElementById('final-score').textContent = this.state.score;
            document.getElementById('max-combo').textContent = this.state.maxCombo;
            document.getElementById('rating-badge').textContent = rating;

            this.showScreen('end-screen');
            Leaderboard.checkNewScore(this.state.score);
        },
        updateUI() {
            document.getElementById('score').textContent = Game.state.score;
            document.getElementById('combo').textContent = Game.state.combo;
        },
        showFeedback(type, text) {
            const feedbackEl = document.createElement('div');
            feedbackEl.className = `feedback ${type}`;
            feedbackEl.textContent = text;
            feedbackContainer.innerHTML = '';
            feedbackContainer.appendChild(feedbackEl);
        },
        showFirstPlayHint() {
            const hints = {
                conductor: { text: '點擊或按住音符！', style: { top: '30%', left: '50%', transform: 'translateX(-50%)' } },
                turntable: { text: '點擊轉動的唱片！', style: { top: '25%', left: '50%', transform: 'translateX(-50%)' } },
                timebeat: { text: '在節拍點擊下落的音符！', style: { bottom: '25%', left: '50%', transform: 'translateX(-50%)' } }
            };
            const hintData = hints[this.state.activeGame];
            const hintEl = document.createElement('div');
            hintEl.className = 'first-play-hint';
            hintEl.textContent = hintData.text;
            Object.assign(hintEl.style, hintData.style);
            
            const gameArea = document.getElementById(`${this.state.activeGame}-game-area`);
            gameArea.appendChild(hintEl);
            setTimeout(() => hintEl.remove(), 4000);
        }
    });

    // --- 歌曲數據 (指向檔案，不再包含譜面) ---
    const SongData = {
        conductor: {
            song1: { title: '男兒當自強', artist: '林子祥', unlockScore: 0, duration: 19100, beatmapFile: 'conductor_song1.json', audioFile: 'conductor_song1.mp3' },
            song2: { title: '月亮代表我的心', artist: '鄧麗君', unlockScore: 2000, duration: 17000, beatmapFile: 'conductor_song2.json', audioFile: 'conductor_song2.mp3' }
        },
        turntable: {
            song1: { title: '甜蜜蜜', artist: '鄧麗君', unlockScore: 0, duration: 21000, beatmapFile: 'turntable_song1.json', audioFile: 'turntable_song1.mp3' },
            song2: { title: '瀟灑走一回', artist: '葉蒨文', unlockScore: 2500, duration: 18000, beatmapFile: 'turntable_song2.json', audioFile: 'turntable_song2.mp3' }
        },
        timebeat: {
            song1: { title: '童年', artist: '羅大佑', unlockScore: 0, duration: 19300, beatmapFile: 'timebeat_song1.json', audioFile: 'timebeat_song1.mp3' },
            song2: { title: '很愛很愛你', artist: '劉若英', unlockScore: 1800, duration: 17000, beatmapFile: 'timebeat_song2.json', audioFile: 'timebeat_song2.mp3' }
        }
    };
    
    // --- 歌曲選擇、排行榜、教學模組 (與之前版本相同，省略以節省篇幅) ---
    const SongOrder = { /* ... */ };
    const SongSelection = { /* ... */ };
    const Leaderboard = { /* ... */ };
    const Tutorial = { /* ... */ };
    Object.assign(SongOrder, { conductor: ['song1', 'song2'], turntable: ['song1', 'song2'], timebeat: ['song1', 'song2'] });
    SongSelection.render = function() {
        const gameType = Game.state.activeGame;
        const titles = { conductor: '指揮樂章', turntable: '時光金曲', timebeat: '節拍情懷' };
        document.getElementById('song-selection-title').textContent = titles[gameType];
        const songListContainer = document.getElementById('song-list');
        songListContainer.innerHTML = '';
        const playerProgress = Leaderboard.playerProgress;
        
        (SongOrder[gameType] || []).forEach((songId, index) => {
            const song = SongData[gameType][songId];
            const prevSongId = index > 0 ? SongOrder[gameType][index - 1] : null;
            const isUnlocked = !prevSongId || (playerProgress[gameType][prevSongId] || 0) >= song.unlockScore;

            const songEl = document.createElement('div');
            songEl.className = 'song-choice' + (isUnlocked ? '' : ' locked');

            if (isUnlocked) {
                const highscore = playerProgress[gameType][songId] ? `<div class="song-highscore">最高分: ${playerProgress[gameType][songId]}</div>` : '';
                songEl.innerHTML = `<div class="song-title">${song.title}</div><div class="song-artist">${song.artist}</div>${highscore}`;
                songEl.addEventListener('click', () => Game.startGame(songId));
            } else {
                const prevSongTitle = SongData[gameType][prevSongId].title;
                songEl.innerHTML = `
                    <div class="song-title">${song.title}</div><div class="song-artist">${song.artist}</div>
                    <div class="song-unlock-condition">完成《${prevSongTitle}》並獲得 ${song.unlockScore} 分</div>
                    <div class="lock-icon">🔒</div>`;
            }
            songListContainer.appendChild(songEl);
        });
    };
    Object.assign(Leaderboard, {
        playerProgress: { conductor: {}, turntable: {}, timebeat: {} },
        leaderboards: { conductor: {}, turntable: {}, timebeat: {} },
        init() {
            try {
                const savedProgress = localStorage.getItem('playerProgress');
                if (savedProgress) this.playerProgress = JSON.parse(savedProgress);
                const savedBoards = localStorage.getItem('leaderboards');
                if (savedBoards) this.leaderboards = JSON.parse(savedBoards);
            } catch (e) { console.error("無法讀取存檔:", e); }

            ['conductor', 'turntable', 'timebeat'].forEach(game => {
                if (!this.playerProgress[game]) this.playerProgress[game] = {};
                if (!this.leaderboards[game]) this.leaderboards[game] = {};
            });

            document.getElementById('submit-score-btn').addEventListener('click', () => this.submitScore());
            document.getElementById('back-from-leaderboard-btn').addEventListener('click', () => Game.showScreen('end-screen'));
        },
        getScores(game, song) {
            if (!this.leaderboards[game][song]) this.leaderboards[game][song] = [];
            return this.leaderboards[game][song];
        },
        addScore(game, song, name, score) {
            const scores = this.getScores(game, song);
            scores.push({ name, score });
            scores.sort((a, b) => b.score - a.score);
            this.leaderboards[game][song] = scores.slice(0, 5);
            this.save();
        },
        checkNewScore(score) {
            const game = Game.state.activeGame;
            const song = Game.state.currentSongId;
            const scores = this.getScores(game, song);
            if (scores.length < 5 || score > (scores[scores.length - 1].score || 0) ) {
                document.getElementById('name-prompt').style.display = 'block';
            } else {
                document.getElementById('name-prompt').style.display = 'none';
            }
            const prevHighScore = this.playerProgress[game][song] || 0;
            if (score > prevHighScore) {
                this.playerProgress[game][song] = score;
                this.save();
            }
        },
        submitScore() {
            const name = document.getElementById('player-name-input').value.toUpperCase() || 'AAA';
            this.addScore(Game.state.activeGame, Game.state.currentSongId, name, Game.state.score);
            document.getElementById('name-prompt').style.display = 'none';
            this.render();
        },
        render() {
            const game = Game.state.activeGame;
            const song = Game.state.currentSongId;
            const songTitle = SongData[game][song].title;
            document.getElementById('leaderboard-title').textContent = `《${songTitle}》排行榜`;
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '';
            const scores = this.getScores(game, song);
            if (scores.length === 0) {
                listEl.innerHTML = '<li>暫無記錄，快來爭奪第一！</li>';
            } else {
                scores.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>#${index + 1} ${entry.name}</span><span>${entry.score}</span>`;
                    listEl.appendChild(li);
                });
            }
        },
        show() {
            Game.showScreen('leaderboard-screen');
            this.render();
        },
        save() {
            try {
                localStorage.setItem('playerProgress', JSON.stringify(this.playerProgress));
                localStorage.setItem('leaderboards', JSON.stringify(this.leaderboards));
            } catch (e) { console.error("無法儲存進度:", e); }
        }
    });
    Tutorial.start = function() { /* Omitted */ }; // The tutorial logic remains the same

    // --- 遊戲邏輯模組 (更新為接收譜面) ---
    const Conductor = {
        // ... (屬性定義與之前相同)
        start(notes, songData) { // *** 接收 notes 和 songData ***
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            this.activeNote = null;
            this.gameArea.innerHTML = '';
            this.startTime = Date.now();
            this.songDuration = songData.duration;
            Game.state.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
        },
        gameLoop() {
            // ... (大部分邏輯相同)
            if (gameTime > this.songDuration && !this.activeNote && this.noteQueue.length === 0) {
                Game.endGame();
            } else {
                Game.state.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
            }
        },
        // ... (其他函數不變)
    };
    const Turntable = {
        // ...
        start(notes, songData) { // *** 接收 notes 和 songData ***
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            // ... (其餘啟動邏輯)
        },
        // ...
    };
    const TimeBeat = {
        // ...
        start(notes, songData) { // *** 接收 notes 和 songData ***
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            // ... (其餘啟動邏輯)
        },
        // ...
    };
    // 為了可讀性，此處僅展示修改的骨架，完整邏輯請參考上一版。
    // 只需將所有 start() 改為 start(notes, songData) 並調整譜面來源即可。
    // 以下為 Conductor 的完整替換範例：
    Object.assign(Conductor, {
        gameArea: document.getElementById('conductor-game-area'),
        pointerPos: { x: 0, y: 0 }, isPointerDown: false, startTime: 0, songDuration: 0,
        noteQueue: [], activeNote: null, holdTimer: null,
        start(notes, songData) {
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            this.activeNote = null;
            this.gameArea.innerHTML = '';
            this.startTime = Date.now();
            this.songDuration = songData.duration;
            Game.state.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
        },
        gameLoop() { /* ... unchanged ... */ },
        spawnNote() { /* ... unchanged ... */ },
        judge(type) { /* ... unchanged ... */ },
        onPointerDown(e) { this.isPointerDown = true; this.updatePointerPos(e); },
        onPointerUp(e) { /* ... unchanged ... */ },
        onPointerMove(e) { /* ... unchanged ... */ },
        updatePointerPos(e) { const touch = e.touches ? e.touches[0] : e; this.pointerPos.x = touch.clientX; this.pointerPos.y = touch.clientY; }
    });

    // --- 全局事件監聽與初始化 ---
    // ... (與之前相同)
    
    // --- 最終初始化 ---
    Leaderboard.init();
    AudioManager.preload();
    Game.init();
    </script>
</body>
</html>