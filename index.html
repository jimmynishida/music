<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>時光迴廊 - 懷舊音樂之旅 v3.1</title>
    <style>
        /* --- 全局與佈局 --- */
        :root {
            --record-size: 300px;
            --theme-color-1: #ff8c00; /* 溫暖的橙色 */
            --theme-color-2: #483d8b; /* 懷舊的暗藍色 */
            --font-family: 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: var(--font-family);
            overflow: hidden;
            touch-action: none;
            background: linear-gradient(135deg, #2a2a3e, #4a3a4a);
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }
        .screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: none; /* 默認全部隱藏 */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            text-align: center;
            transition: opacity 0.5s ease;
        }
        .screen.active { display: flex; }
        .screen.hidden { opacity: 0; pointer-events: none; }

        .retro-button {
            padding: 12px 28px; font-size: 18px; color: white;
            background: linear-gradient(145deg, var(--theme-color-1), #e06a00);
            border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 8px;
            cursor: pointer; margin: 10px;
            box-shadow: 0 4px 0 #a04a00, 2px 2px 8px rgba(0,0,0,0.5);
            transition: all 0.1s ease-out;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .retro-button:active { transform: translateY(2px); box-shadow: 0 2px 0 #a04a00; }
        h1 { font-size: 42px; text-shadow: 2px 2px 8px rgba(0,0,0,0.8); }
        p { opacity: 0.9; }

        /* --- 主選單 (時光迴廊) --- */
        #main-menu-screen {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://source.unsplash.com/random/800x600/?80s,retro,city') no-repeat center center/cover;
        }
        #main-menu-screen h1 { font-size: 48px; }
        .game-choice-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; margin-top: 30px; }
        .game-choice-card {
            width: 150px; height: 200px; margin: 15px;
            border: 3px solid rgba(255, 255, 255, 0.7); border-radius: 12px;
            background: rgba(0,0,0,0.4);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s ease;
        }
        .game-choice-card:hover { transform: scale(1.05); border-color: var(--theme-color-1); }
        .game-choice-card .icon { font-size: 60px; }
        .game-choice-card .title { font-size: 24px; margin-top: 15px; font-weight: bold; }

        /* --- 玩法示範 --- */
        #tutorial-screen .tutorial-container { position: relative; width: 300px; height: 400px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; box-sizing: border-box; }
        #tutorial-screen h2 { margin-bottom: 20px; }
        .tutorial-item { position: absolute; width: 90%; height: 80%; top: 15%; left: 5%; opacity: 0; transition: opacity 0.8s ease-in-out; text-align: center; }
        .tutorial-item.active { opacity: 1; }
        .demo-finger {
            width: 40px; height: 40px; background-color: rgba(255,255,255,0.8); border-radius: 50%;
            position: absolute; box-shadow: 0 0 15px white; transform: translate(-50%, -50%);
            z-index: 10; pointer-events: none;
        }
        .demo-note {
            position: absolute; background-color: #ffd700; border-radius: 50%; box-shadow: 0 0 15px #ffd700;
            transform: translate(-50%, -50%); pointer-events: none;
        }

        /* --- 歌曲選擇 --- */
        #song-selection-screen { backdrop-filter: blur(10px); }
        #song-list { width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto; padding-top: 10px; }
        .song-choice {
            background-color: rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px;
            padding: 15px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .song-choice:not(.locked):hover { border-color: var(--theme-color-1); transform: scale(1.02); }
        .song-choice.locked { cursor: not-allowed; background-color: rgba(0,0,0,0.5); color: #888; }
        .song-title { font-size: 20px; font-weight: bold; }
        .song-artist { font-size: 14px; opacity: 0.8; margin-top: 5px; }
        .song-highscore, .song-unlock-condition { font-size: 12px; margin-top: 8px; color: var(--theme-color-1); }
        .lock-icon { font-size: 28px; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); opacity: 0.7; }

        /* --- 遊戲通用 UI --- */
        .game-ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; pointer-events: none;
            justify-content: center; align-items: center;
        }
        .game-ui-container.active { display: flex; }
        .game-stats {
            position: absolute; top: 20px; left: 20px; right: 20px; z-index: 50;
            display: flex; justify-content: space-between; font-size: 24px;
            color: white; text-shadow: 2px 2px 4px black; pointer-events: auto;
        }
        .feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 48px; font-weight: bold; pointer-events: none; z-index: 101;
            opacity: 0; animation: feedback-anim 1s forwards;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
        }
        .feedback.perfect { color: #ffd700; }
        .feedback.good { color: #87ceeb; }
        .feedback.miss { color: #ff69b4; }
        .first-play-hint {
            position: absolute; background-color: rgba(0,0,0,0.8); padding: 10px 15px; border-radius: 8px;
            color: white; font-size: 16px; pointer-events: none; z-index: 200;
            opacity: 0; animation: feedback-anim 3s forwards;
        }
        .game-background {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: filter 0.5s ease-out; z-index: -1;
        }

        /* --- 指揮家 遊戲樣式 --- */
        #conductor-game-area { width: 100%; height: 100%; cursor: crosshair; pointer-events: auto; }
        #conductor-game-area .note {
            position: absolute; width: 50px; height: 50px; border-radius: 50%;
            transform: translate(-50%, -50%) scale(0); transition: transform 0.3s ease-out;
            z-index: 10; background-color: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.7);
            display: flex; justify-content: center; align-items: center;
        }
        #conductor-game-area .note.active {
            transform: translate(-50%, -50%) scale(1);
            background-color: rgba(30, 144, 255, 0.5);
            border-color: #1e90ff; animation: pulse-blue 1.5s infinite;
        }
        #conductor-game-area .note.strong.active {
            transform: translate(-50%, -50%) scale(1.3);
            background-color: rgba(255, 100, 100, 0.7);
            border-color: #ff4500; animation: pulse-red 1.5s infinite;
        }
        #conductor-game-area .trail {
            position: absolute; width: 20px; height: 20px;
            background: radial-gradient(circle, rgba(255, 223, 186, 0.8) 0%, rgba(255, 223, 186, 0) 70%);
            border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 5; pointer-events: none; animation: fade-out 0.5s forwards;
        }

        /* --- 時光唱盤 遊戲樣式 --- */
        #turntable-game-area { width: var(--record-size); height: var(--record-size); pointer-events: auto; }
        #turntable-game-area .record { width: 100%; height: 100%; background: radial-gradient(circle, #555 10%, #444 11%, #333 12%, #333 100%); border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: spin 10s linear infinite; animation-play-state: paused; }
        #turntable-game-area .record::before { content: ''; position: absolute; width: 90%; height: 90%; border-radius: 50%; background-image: repeating-radial-gradient(circle, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 1px, transparent 1px, transparent 4px); }
        #turntable-game-area .record-label { width: 35%; height: 35%; background-color: #d2b48c; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 11px; color: #5d4037; font-weight: bold; z-index: 1; border: 2px solid #a1887f; padding: 5px; box-sizing: border-box; }
        #turntable-game-area .judgment-zone { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; border: 2px solid rgba(255, 223, 186, 0.7); border-radius: 50%; z-index: 10; }
        #turntable-game-area .tonearm { position: absolute; width: 150px; height: 8px; background: linear-gradient(to right, #ccc, #eee); border-radius: 4px; top: calc(50% - 4px); left: 50%; transform-origin: calc(150px - 20px) 50%; z-index: 20; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: grab; }
        #turntable-game-area .stylus { position: absolute; width: 12px; height: 12px; background-color: #333; border: 2px solid #fff; border-radius: 50%; top: -4px; left: -4px; }
        #turntable-game-area .note { position: absolute; width: 40px; height: 10px; background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.8), transparent); border-radius: 5px; transform-origin: calc(var(--record-size) / 2 - 25px) center; top: 25px; left: calc(50% - 20px); z-index: 5; }
        #turntable-game-area .note.strong { background: linear-gradient(90deg, transparent, rgba(255, 100, 100, 1), transparent); box-shadow: 0 0 10px #ff4500; }

        /* --- 時光節拍 遊戲樣式 --- */
        #timebeat-game-area canvas { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; }
        #timebeat-game-area .combo-display {
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             font-size: 4rem; font-weight: bold; color: rgba(255, 255, 255, 0.5); opacity: 0;
             transition: opacity 0.2s, transform 0.2s;
        }
        #timebeat-game-area .combo-display.show { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }

        /* --- 結束與排行榜畫面 --- */
        #end-screen-content { padding: 20px; }
        #leaderboard-screen input { width: 100px; font-size: 24px; text-align: center; background: #333; color: white; border: 2px solid #ccc; border-radius: 5px; margin: 10px 0; text-transform: uppercase; }
        #leaderboard-list { list-style: none; padding: 0; width: 80%; max-width: 350px; margin-top: 20px; }
        #leaderboard-list li { display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; }
        #leaderboard-list li:first-child { background: var(--theme-color-1); font-weight: bold; }
        #poster-button { margin-top: 15px; }
        #poster-preview-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 1000; }
        #poster-canvas { border: 2px solid white; border-radius: 10px; max-width: 90vw; max-height: 90vh; }

        /* --- 動畫 --- */
        @keyframes feedback-anim { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 80% { opacity: 1; } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 10px #1e90ff; } 50% { box-shadow: 0 0 25px #1e90ff; } 100% { box-shadow: 0 0 10px #1e90ff; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 10px #ff4500; } 50% { box-shadow: 0 0 25px #ff4500; } 100% { box-shadow: 0 0 10px #ff4500; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="conductor-game-area" class="game-ui-container">
             <div class="game-background"></div>
        </div>
        <div id="turntable-game-area" class="game-ui-container">
             <div class="game-background"></div>
             <div class="record"><div class="record-label"></div></div>
             <div class="tonearm"><div class="stylus"></div></div>
             <div class="judgment-zone"></div>
        </div>
        <div id="timebeat-game-area" class="game-ui-container">
            <div class="game-background"></div>
            <div class="combo-display"></div>
            <canvas id="timebeat-canvas"></canvas>
        </div>
        
        <div class="game-stats" style="display: none;">
            <div>分數: <span id="score">0</span></div>
            <div>連擊: <span id="combo">0</span></div>
        </div>
    </div>

    <div id="main-menu-screen" class="screen active">
        <h1>時光迴廊</h1>
        <p>選擇你的懷舊音樂之旅</p>
        <div class="game-choice-container">
            <div class="game-choice-card" data-gametype="timebeat">
                <div class="icon">🎶</div>
                <div class="title">時光節拍</div>
            </div>
            <div class="game-choice-card" data-gametype="conductor">
                <div class="icon">🎼</div>
                <div class="title">指揮家</div>
            </div>
            <div class="game-choice-card" data-gametype="turntable">
                <div class="icon">💿</div>
                <div class="title">時光唱盤</div>
            </div>
        </div>
        <button class="retro-button" id="show-tutorial-btn">玩法示範</button>
    </div>

    <div id="tutorial-screen" class="screen">
        <div class="tutorial-container">
             <h2>玩法示範</h2>
             <div id="tutorial-content"></div>
        </div>
        <button class="retro-button" id="skip-tutorial-btn">返回主選單</button>
    </div>

    <div id="song-selection-screen" class="screen">
        <h1 id="song-selection-title">選擇曲目</h1>
        <div id="song-list"></div>
        <button class="retro-button" id="back-to-main-menu-btn">返回主選單</button>
    </div>

    <div id="end-screen" class="screen">
        <div id="end-screen-content">
            <h1 id="end-title">演奏結束</h1>
            <p style="font-size: 24px;">最終得分: <span id="final-score">0</span></p>
            <p>最高連擊: <span id="max-combo">0</span></p>
            <p>準確率: <span id="accuracy">0%</span></p>
            <p style="font-size: 32px; font-weight: bold; color: gold;">評級: <span id="rating-badge"></span></p>
            <button id="poster-button" class="retro-button">生成勳章海報</button>
            <button id="view-leaderboard-btn" class="retro-button">查看排行榜</button>
            <button id="retry-button" class="retro-button">再次嘗試</button>
            <button id="back-to-song-menu-btn" class="retro-button">返回選曲</button>
        </div>
    </div>
    
    <div id="leaderboard-screen" class="screen">
        <h1 id="leaderboard-title">歌曲排行榜</h1>
        <div id="name-prompt" style="display: none;">
            <h3>恭喜創下新紀錄！請留下你的大名 (3個字母)：</h3>
            <input type="text" id="player-name-input" maxlength="3" value="AAA">
            <button id="submit-score-btn" class="retro-button">提交分數</button>
        </div>
        <ol id="leaderboard-list"></ol>
        <button class="retro-button" id="back-from-leaderboard-btn">返回</button>
    </div>
    
    <div id="poster-preview-container" onclick="this.style.display='none'">
        <canvas id="poster-canvas"></canvas>
    </div>

    <audio id="game-audio" preload="auto"></audio>

    <script>
    // =================================================================================
    //  時光迴廊 H5 遊戲 - 統一程式碼框架 v3.1
    // =================================================================================

    // --- 1. 全局狀態與 DOM ---
    const allScreens = document.querySelectorAll('.screen');
    const gameUIs = document.querySelectorAll('.game-ui-container');
    const gameStatsEl = document.querySelector('.game-stats');
    const gameAudio = document.getElementById('game-audio');

    const Game = {
        state: {
            activeGame: null, currentSongId: null, score: 0, combo: 0, maxCombo: 0,
            hits: { perfect: 0, good: 0, miss: 0 }, totalNotes: 0, accuracy: 0, rating: 'C',
            isPlaying: false, isFirstPlay: {}, startTime: null, animationFrameId: null,
        },
        // --- 遊戲初始化與畫面管理 ---
        init() {
            const firstPlayData = localStorage.getItem('isFirstPlay');
            this.state.isFirstPlay = firstPlayData ? JSON.parse(firstPlayData) : { conductor: true, turntable: true, timebeat: true };

            document.querySelectorAll('.game-choice-card').forEach(card => card.addEventListener('click', () => {
                this.state.activeGame = card.dataset.gametype; this.showScreen('song-selection-screen'); SongSelection.render();
            }));
            document.getElementById('back-to-main-menu-btn').addEventListener('click', () => this.showScreen('main-menu-screen'));
            document.getElementById('show-tutorial-btn').addEventListener('click', () => { this.showScreen('tutorial-screen'); Tutorial.start(); });
            document.getElementById('skip-tutorial-btn').addEventListener('click', () => { Tutorial.stop(); this.showScreen('main-menu-screen'); });
            
            document.getElementById('retry-button').addEventListener('click', () => this.startGame(this.state.currentSongId));
            document.getElementById('back-to-song-menu-btn').addEventListener('click', () => { this.showScreen('song-selection-screen'); SongSelection.render(); });
            document.getElementById('view-leaderboard-btn').addEventListener('click', () => Leaderboard.show());
            document.getElementById('poster-button').addEventListener('click', () => this.generatePoster());

            Leaderboard.init();
            this.showScreen('main-menu-screen');
        },
        showScreen(screenId) {
            allScreens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
        },
        // --- 遊戲核心流程 ---
        startGame(songId) {
            if (this.state.isFirstPlay[this.state.activeGame]) {
                this.showFirstPlayHint();
                this.state.isFirstPlay[this.state.activeGame] = false;
                localStorage.setItem('isFirstPlay', JSON.stringify(this.state.isFirstPlay));
            }

            Object.assign(this.state, { currentSongId: songId, score: 0, combo: 0, maxCombo: 0, hits: { perfect: 0, good: 0, miss: 0 }, isPlaying: true, startTime: null });
            if(this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);

            allScreens.forEach(s => s.classList.remove('active'));
            gameUIs.forEach(ui => ui.classList.remove('active'));
            const activeGameArea = document.getElementById(`${this.state.activeGame}-game-area`);
            activeGameArea.classList.add('active');
            
            gameStatsEl.style.display = 'flex';
            document.getElementById('score').textContent = 0;
            document.getElementById('combo').textContent = 0;

            const songData = SongData[this.state.activeGame][songId];
            this.state.totalNotes = songData.notes.length;
            gameAudio.src = songData.audioSrc;
            gameAudio.currentTime = 0;

            const backgroundEl = activeGameArea.querySelector('.game-background');
            if(backgroundEl) backgroundEl.style.backgroundImage = `url('${songData.backgroundSrc}')`;
            
            const gameModule = window[this.state.activeGame.charAt(0).toUpperCase() + this.state.activeGame.slice(1)];
            if (gameModule) gameModule.start();
        },
        endGame() {
            if (!this.state.isPlaying) return;
            this.state.isPlaying = false;
            if(this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
            this.state.animationFrameId = null;
            gameAudio.pause();
            gameStatsEl.style.display = 'none';

            const perfectScore = this.state.hits.perfect * 2;
            const goodScore = this.state.hits.good;
            const maxPossibleScore = (this.state.totalNotes > 0) ? ((this.state.totalNotes - this.state.hits.miss) * 2) : 0;
            this.state.accuracy = maxPossibleScore > 0 ? ((perfectScore + goodScore) / maxPossibleScore) * 100 : 0;
            
            if (this.state.accuracy >= 100 && this.state.hits.miss === 0) this.state.rating = 'S+';
            else if (this.state.accuracy > 95) this.state.rating = 'S';
            else if (this.state.accuracy > 90) this.state.rating = 'A';
            else if (this.state.accuracy > 80) this.state.rating = 'B';
            else this.state.rating = 'C';
            
            const songData = SongData[this.state.activeGame][this.state.currentSongId];
            document.getElementById('end-title').textContent = songData.title;
            document.getElementById('final-score').textContent = this.state.score;
            document.getElementById('max-combo').textContent = this.state.maxCombo;
            document.getElementById('accuracy').textContent = `${this.state.accuracy.toFixed(2)}%`;
            document.getElementById('rating-badge').textContent = this.state.rating;

            this.showScreen('end-screen');
            Leaderboard.checkNewScore(this.state.score);
        },
        showFirstPlayHint() {
            const hintText = {
                timebeat: '跟隨節拍，點擊下落的音符！',
                conductor: '跟隨光流滑動，在音符處點擊！',
                turntable: '拖動唱臂對準旋轉的節拍線！'
            }[this.state.activeGame];
            const hintEl = document.createElement('div');
            hintEl.className = 'first-play-hint';
            hintEl.textContent = hintText;
            hintEl.style.top = '30%'; hintEl.style.left = '50%'; hintEl.style.transform = 'translateX(-50%)';
            document.body.appendChild(hintEl);
            setTimeout(() => hintEl.remove(), 3000);
        },
        generatePoster() {
             const posterCanvas = document.getElementById('poster-canvas');
            const pCtx = posterCanvas.getContext('2d');
            const width = 400; const height = 600;
            posterCanvas.width = width; posterCanvas.height = height;
            const song = SongData[this.state.activeGame][this.state.currentSongId];
            const bgImg = new Image();
            bgImg.crossOrigin = "Anonymous";
            bgImg.src = song.backgroundSrc;
            bgImg.onload = () => {
                pCtx.drawImage(bgImg, 0, 0, width, height);
                pCtx.fillStyle = 'rgba(0, 0, 0, 0.6)'; pCtx.fillRect(0, 0, width, height);
                pCtx.fillStyle = 'gold'; pCtx.beginPath(); pCtx.moveTo(width/2, 80);
                for (let i = 0; i < 5; i++) { pCtx.lineTo(width/2 + 50 * Math.cos(Math.PI * (0.9 + i * 0.8)), 80 + 50 * Math.sin(Math.PI * (0.9 + i * 0.8))); }
                pCtx.closePath(); pCtx.fill();
                pCtx.fillStyle = 'white'; pCtx.font = 'bold 30px sans-serif'; pCtx.textAlign = 'center'; pCtx.textBaseline = 'middle';
                pCtx.fillText(this.state.rating, width/2, 85);
                pCtx.fillStyle = 'white'; pCtx.font = 'bold 28px sans-serif';
                pCtx.fillText(song.title, width/2, 180);
                pCtx.font = '20px sans-serif';
                pCtx.fillText(`分數: ${this.state.score}`, width/2, 240);
                pCtx.fillText(`最大連擊: ${this.state.maxCombo}`, width/2, 280);
                pCtx.fillText(`準確率: ${this.state.accuracy.toFixed(2)}%`, width/2, 320);
                pCtx.font = 'italic bold 32px sans-serif'; pCtx.fillStyle = 'cyan';
                pCtx.fillText('時光迴廊', width/2, 450);
                pCtx.font = '14px sans-serif'; pCtx.fillStyle = 'lightgray';
                pCtx.fillText('長按圖片即可儲存分享', width/2, 550);
                document.getElementById('poster-preview-container').style.display = 'flex';
            };
            bgImg.onerror = () => {
                pCtx.fillStyle = '#333'; pCtx.fillRect(0, 0, width, height);
                pCtx.fillStyle = 'white'; pCtx.font = '24px sans-serif'; pCtx.textAlign = 'center'; pCtx.textBaseline = 'middle';
                pCtx.fillText('背景圖片加載失敗', width/2, height/2);
                document.getElementById('poster-preview-container').style.display = 'flex';
            }
        },
        util: {
            playAudio() {
                const playPromise = gameAudio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        gameAudio.pause();
                        setTimeout(() => {
                            gameAudio.currentTime = 0;
                            gameAudio.play();
                            Game.state.startTime = performance.now();
                            const gameModule = window[Game.state.activeGame.charAt(0).toUpperCase() + Game.state.activeGame.slice(1)];
                            gameModule.gameLoop(Game.state.startTime);
                        }, 1500);
                    }).catch(error => {
                        alert("無法自動播放音訊。請與頁面交互後再試。");
                    });
                }
            },
            showFeedback(type, text) {
                const feedbackEl = document.createElement('div');
                feedbackEl.className = `feedback ${type}`;
                feedbackEl.textContent = text;
                document.body.appendChild(feedbackEl);
                setTimeout(() => feedbackEl.remove(), 1000);
            },
            updateUI() {
                document.getElementById('score').textContent = Game.state.score;
                document.getElementById('combo').textContent = Game.state.combo;
            }
        }
    };
    
    // --- 2. 歌曲數據 ---
    const SongData = {
        timebeat: {
            tongnian: { title: '童年', artist: '羅大佑', unlockScore: 0, duration: 19300, audioSrc: 'https://cdn.jsdelivr.net/gh/c-at/music-box@main/audio/童年.mp3', backgroundSrc: 'https://source.unsplash.com/random/800x600/?childhood,play', notes: JSON.parse('[{"time":1.5,"type":"tap"},{"time":3,"type":"tap"},{"time":4.4,"type":"strong"},{"time":6,"type":"tap"},{"time":7.2,"type":"tap"},{"time":9,"type":"strong"},{"time":10.3,"type":"tap"},{"time":11.7,"type":"tap"},{"time":13,"type":"tap"},{"time":14.5,"type":"strong"},{"time":16,"type":"tap"},{"time":17.3,"type":"tap"}]').map(n => ({...n, time: n.time * 1000}))},
            tianmimi: { title: '甜蜜蜜', artist: '鄧麗君', unlockScore: 6000, duration: 21000, audioSrc: 'https://cdn.jsdelivr.net/gh/c-at/music-box@main/audio/甜蜜蜜.mp3', backgroundSrc: 'https://source.unsplash.com/random/800x600/?sweet,love', notes: JSON.parse('[{"time":2,"type":"tap"},{"time":3.2,"type":"tap"},{"time":4.5,"type":"strong"},{"time":7,"type":"tap"},{"time":8.2,"type":"tap"},{"time":9.4,"type":"tap"},{"time":10.6,"type":"strong"},{"time":11.8,"type":"tap"},{"time":14,"type":"tap"},{"time":15.2,"type":"tap"},{"time":16.5,"type":"strong"},{"time":17.8,"type":"tap"},{"time":19,"type":"tap"}]').map(n => ({...n, time: n.time * 1000}))}
        },
        conductor: {
            yueliang: { title: '月亮代表我的心', artist: '鄧麗君', unlockScore: 0, duration: 17000, audioSrc: 'https://cdn.jsdelivr.net/gh/c-at/music-box@main/audio/月亮代表我的心.mp3', backgroundSrc: 'https://source.unsplash.com/random/800x600/?moon,night', notes: JSON.parse('[{"time":1,"type":"tap"},{"time":2.4,"type":"tap"},{"time":3.6,"type":"strong"},{"time":5,"type":"tap"},{"time":6.2,"type":"tap"},{"time":7.5,"type":"strong"},{"time":8.8,"type":"tap"},{"time":10,"type":"tap"},{"time":11.2,"type":"tap"},{"time":12.6,"type":"strong"},{"time":13.8,"type":"tap"},{"time":15,"type":"tap"}]').map(n => ({...n, time: n.time * 1000}))},
            henai: { title: '很愛很愛你', artist: '劉若英', unlockScore: 6000, duration: 17000, audioSrc: 'https://cdn.jsdelivr.net/gh/c-at/music-box@main/audio/很愛很愛你.mp3', backgroundSrc: 'https://source.unsplash.com/random/800x600/?love,letter', notes: JSON.parse('[{"time":1.8,"type":"tap"},{"time":3,"type":"tap"},{"time":4.2,"type":"tap"},{"time":5.4,"type":"strong"},{"time":6.6,"type":"tap"},{"time":7.8,"type":"tap"},{"time":9,"type":"tap"},{"time":10.2,"type":"strong"},{"time":11.4,"type":"tap"},{"time":12.6,"type":"tap"},{"time":13.8,"type":"tap"},{"time":15,"type":"strong"}]').map(n => ({...n, time: n.time * 1000}))}
        },
        turntable: {
             naner: { title: '男兒當自強', artist: '林子祥', unlockScore: 0, duration: 19100, audioSrc: 'https://cdn.jsdelivr.net/gh/c-at/music-box@main/audio/男兒當自強.mp3', backgroundSrc: 'https://source.unsplash.com/random/800x600/?kungfu,china', notes: JSON.parse('[{"time":2.5,"type":"strong"},{"time":3.8,"type":"tap"},{"time":5.2,"type":"tap"},{"time":6.6,"type":"strong"},{"time":8,"type":"tap"},{"time":9.2,"type":"tap"},{"time":10.7,"type":"strong"},{"time":12,"type":"tap"},{"time":13.2,"type":"tap"},{"time":14.4,"type":"strong"},{"time":15.8,"type":"tap"},{"time":17.1,"type":"tap"}]').map(n => ({...n, time: n.time * 1000}))},
             xiaosa: { title: '瀟灑走一回', artist: '葉倩文', unlockScore: 7000, duration: 18000, audioSrc: 'https://cdn.jsdelivr.net/gh/c-at/music-box@main/audio/瀟灑走一回.mp3', backgroundSrc: 'https://source.unsplash.com/random/800x600/?journey,wind', notes: JSON.parse('[{"time":2.2,"type":"tap"},{"time":3.5,"type":"tap"},{"time":4.7,"type":"strong"},{"time":6,"type":"tap"},{"time":7.3,"type":"tap"},{"time":8.5,"type":"strong"},{"time":9.7,"type":"tap"},{"time":11,"type":"tap"},{"time":12.2,"type":"strong"},{"time":13.4,"type":"tap"},{"time":14.7,"type":"tap"},{"time":16,"type":"strong"}]').map(n => ({...n, time: n.time * 1000}))}
        }
    };
    const SongOrder = {
        timebeat: ['tongnian', 'tianmimi'],
        conductor: ['yueliang', 'henai'],
        turntable: ['naner', 'xiaosa'],
    };
    
    // --- 3. 排行榜 & 歌曲選擇 ---
    const Leaderboard = {
        playerProgress: { conductor: {}, turntable: {}, timebeat: {} },
        leaderboards: { conductor: {}, turntable: {}, timebeat: {} },
        init() {
            const savedProgress = localStorage.getItem('playerProgress_v3');
            if (savedProgress) this.playerProgress = JSON.parse(savedProgress); else this.save();
            const savedBoards = localStorage.getItem('leaderboards_v3');
            if (savedBoards) this.leaderboards = JSON.parse(savedBoards); else this.save();

            document.getElementById('submit-score-btn').addEventListener('click', () => this.submitScore());
            document.getElementById('back-from-leaderboard-btn').addEventListener('click', () => Game.showScreen('end-screen'));
        },
        getScores(game, song) {
            if (!this.leaderboards[game]) this.leaderboards[game] = {};
            if (!this.leaderboards[game][song]) this.leaderboards[game][song] = [];
            return this.leaderboards[game][song];
        },
        addScore(game, song, name, score) {
            const scores = this.getScores(game, song);
            scores.push({ name, score });
            scores.sort((a, b) => b.score - a.score);
            this.leaderboards[game][song] = scores.slice(0, 5);
            this.save();
        },
        checkNewScore(score) {
            const game = Game.state.activeGame;
            const song = Game.state.currentSongId;
            const scores = this.getScores(game, song);
            if (scores.length < 5 || score > scores[scores.length - 1].score) {
                document.getElementById('name-prompt').style.display = 'block';
            } else {
                document.getElementById('name-prompt').style.display = 'none';
            }
            if (!this.playerProgress[game]) this.playerProgress[game] = {};
            const prevHighScore = this.playerProgress[game][song] || 0;
            if (score > prevHighScore) {
                this.playerProgress[game][song] = score;
                this.save();
            }
        },
        submitScore() {
            const nameInput = document.getElementById('player-name-input');
            const name = nameInput.value.toUpperCase() || 'AAA';
            this.addScore(Game.state.activeGame, Game.state.currentSongId, name, Game.state.score);
            document.getElementById('name-prompt').style.display = 'none';
            this.render();
            nameInput.value = "AAA";
        },
        render() {
            const game = Game.state.activeGame;
            const song = Game.state.currentSongId;
            const songTitle = SongData[game][song].title;
            document.getElementById('leaderboard-title').textContent = `《${songTitle}》排行榜`;
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '';
            const scores = this.getScores(game, song);
            if (scores.length === 0) { listEl.innerHTML = '<li>暫無記錄，快來爭奪第一！</li>'; } 
            else { scores.forEach((entry, index) => { const li = document.createElement('li'); li.innerHTML = `<span>#${index + 1} ${entry.name}</span><span>${entry.score}</span>`; listEl.appendChild(li); }); }
        },
        show() { Game.showScreen('leaderboard-screen'); this.render(); },
        save() {
            localStorage.setItem('playerProgress_v3', JSON.stringify(this.playerProgress));
            localStorage.setItem('leaderboards_v3', JSON.stringify(this.leaderboards));
        }
    };
    const SongSelection = {
        render() {
            const gameType = Game.state.activeGame;
            const titleMap = { timebeat: '時光節拍', conductor: '指揮樂章', turntable: '懷舊唱盤' };
            document.getElementById('song-selection-title').textContent = titleMap[gameType] || '選擇曲目';
            
            const songListContainer = document.getElementById('song-list');
            songListContainer.innerHTML = '';
            const playerProgress = Leaderboard.playerProgress;
            
            SongOrder[gameType].forEach((songId, index) => {
                const song = SongData[gameType][songId];
                const prevSongId = index > 0 ? SongOrder[gameType][index - 1] : null;
                const isUnlocked = !prevSongId || (playerProgress[gameType] && (playerProgress[gameType][prevSongId] || 0) >= song.unlockScore);
                const songEl = document.createElement('div');
                songEl.className = 'song-choice' + (isUnlocked ? '' : ' locked');
                if (isUnlocked) {
                    const highscore = (playerProgress[gameType] && playerProgress[gameType][songId]) ? `<div class="song-highscore">最高分: ${playerProgress[gameType][songId]}</div>` : '';
                    songEl.innerHTML = `<div class="song-title">${song.title}</div><div class="song-artist">${song.artist}</div>${highscore}`;
                    songEl.addEventListener('click', () => Game.startGame(songId));
                } else {
                    const prevSongTitle = SongData[gameType][prevSongId].title;
                    songEl.innerHTML = `<div class="song-title">${song.title}</div><div class="song-artist">${song.artist}</div><div class="song-unlock-condition">完成《${prevSongTitle}》並獲得 ${song.unlockScore} 分</div><div class="lock-icon">🔒</div>`;
                }
                songListContainer.appendChild(songEl);
            });
        }
    };
    
    // --- 4. 遊戲邏輯模組 ---
    const TimeBeat = {
        canvas: document.getElementById('timebeat-canvas'),
        ctx: null, notes: [], nextNoteIndex: 0,
        comboDisplay: document.querySelector('#timebeat-game-area .combo-display'),
        gameBackground: document.querySelector('#timebeat-game-area .game-background'),
        start() {
            this.ctx = this.canvas.getContext('2d');
            this.resizeCanvas();
            window.addEventListener('resize', this.resizeCanvas.bind(this));
            this.canvas.addEventListener('pointerdown', this.handleTap.bind(this));
            
            const songData = SongData.timebeat[Game.state.currentSongId];
            this.notes = [];
            this.nextNoteIndex = 0;
            
            let trackCounter = 0;
            const trackPattern = [0, 1, 2, 1];
            this.beatmap = songData.notes.map(note => ({ ...note, track: trackPattern[trackCounter++ % trackPattern.length] }));
            
            Game.util.playAudio();
        },
        gameLoop(currentTime) {
            if (!Game.state.isPlaying) return;
            const elapsedTime = performance.now() - Game.state.startTime;
            
            while (this.nextNoteIndex < this.beatmap.length && this.beatmap[this.nextNoteIndex].time < elapsedTime + 2000) {
                this.notes.push({ ...this.beatmap[this.nextNoteIndex], y: 0, active: true });
                this.nextNoteIndex++;
            }
            this.update(elapsedTime);
            this.draw();
            const songDuration = SongData.timebeat[Game.state.currentSongId].duration;
            if (elapsedTime >= songDuration) { Game.endGame(); return; }
            Game.state.animationFrameId = requestAnimationFrame(this.gameLoop.bind(this));
        },
        update(elapsedTime) {
            const hitLineY = this.canvas.height * 0.85;
            this.notes.forEach(note => {
                if (note.active) {
                    const timeDiff = note.time - elapsedTime;
                    note.y = hitLineY - (timeDiff * 0.8);
                    if (timeDiff < -150) {
                        note.active = false; Game.state.hits.miss++; this.resetCombo();
                    }
                }
            });
            this.notes = this.notes.filter(note => note.active || note.y < this.canvas.height);
        },
        draw() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            const numTracks = 3, trackWidth = this.canvas.width / numTracks, hitLineY = this.canvas.height * 0.85;
            this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; this.ctx.lineWidth = 2;
            for (let i = 1; i < numTracks; i++) { this.ctx.beginPath(); this.ctx.moveTo(trackWidth * i, 0); this.ctx.lineTo(trackWidth * i, this.canvas.height); this.ctx.stroke(); }
            this.ctx.fillStyle = 'rgba(255, 215, 0, 0.5)'; this.ctx.fillRect(0, hitLineY - 25, this.canvas.width, 50);
            this.ctx.strokeStyle = 'gold'; this.ctx.lineWidth = 3; this.ctx.strokeRect(0, hitLineY - 25, this.canvas.width, 50);
            this.notes.forEach(note => {
                if (note.active && note.y > -50 && note.y < this.canvas.height) {
                    const x = trackWidth * note.track + trackWidth / 2;
                    const isStrong = note.type === 'strong';
                    const radius = isStrong ? trackWidth * 0.45 : trackWidth * 0.35;
                    this.ctx.beginPath(); this.ctx.arc(x, note.y, radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = isStrong ? 'orangered' : 'cyan'; this.ctx.shadowColor = isStrong ? 'orangered' : 'cyan';
                    this.ctx.shadowBlur = 15; this.ctx.fill(); this.ctx.shadowBlur = 0;
                }
            });
        },
        handleTap(e) {
            if (!Game.state.startTime) return;
            const rect = this.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const track = Math.floor(x / (this.canvas.width / 3));
            const elapsedTime = performance.now() - Game.state.startTime;
            let judged = false;
            for (let i = 0; i < this.notes.length; i++) {
                const note = this.notes[i];
                if (!judged && note.active && note.track === track) {
                    const timeDiff = Math.abs(note.time - elapsedTime);
                    if (timeDiff < 150) {
                        judged = true; note.active = false;
                        const isStrong = note.type === 'strong';
                        if (timeDiff < 70) {
                            Game.state.score += (isStrong ? 200 : 100) + Game.state.combo * 5; Game.state.hits.perfect++;
                            Game.util.showFeedback('perfect', `完美!`);
                        } else {
                            Game.state.score += (isStrong ? 100 : 50); Game.state.hits.good++;
                            Game.util.showFeedback('good', '不錯!');
                        }
                        Game.state.combo++; Game.state.maxCombo = Math.max(Game.state.maxCombo, Game.state.combo);
                        this.updateComboDisplay(); this.updateBackgroundBlur();
                    }
                }
            }
            Game.util.updateUI();
        },
        resetCombo() { Game.state.combo = 0; this.updateComboDisplay(); this.updateBackgroundBlur(); Game.util.updateUI(); },
        updateComboDisplay() { /* ... */ },
        updateBackgroundBlur() { /* ... */ },
        resizeCanvas() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; }
    };
    // Fill in missing methods for TimeBeat
    TimeBeat.updateComboDisplay = function() {
        if (Game.state.combo > 2) {
            this.comboDisplay.textContent = `${Game.state.combo} COMBO`;
            this.comboDisplay.classList.add('show');
            setTimeout(() => this.comboDisplay.classList.remove('show'), 200);
        } else {
            this.comboDisplay.textContent = '';
        }
    };
    TimeBeat.updateBackgroundBlur = function() {
        const maxBlur = 15, comboForMaxClarity = 50;
        let blurAmount = maxBlur - (Math.min(Game.state.combo, comboForMaxClarity) / comboForMaxClarity) * maxBlur;
        this.gameBackground.style.filter = `blur(${blurAmount}px)`;
    };


    const Conductor = {
        gameArea: document.getElementById('conductor-game-area'),
        pointerPos: { x: 0, y: 0 }, isPointerDown: false,
        noteQueue: [], activeNote: null,
        start() {
            this.isPointerDown = false;
            const songData = SongData.conductor[Game.state.currentSongId];
            this.noteQueue = JSON.parse(JSON.stringify(songData.notes));
            // 為指揮家譜面動態生成座標
            let lastPos = { x: 50, y: 50 };
            this.noteQueue.forEach((note, i) => {
                note.x = lastPos.x + Math.sin(i * 0.8) * 30 * (i % 2 === 0 ? 1 : -1);
                note.y = 50 + Math.cos(i * 1.2) * 25;
                note.x = Math.max(15, Math.min(85, note.x)); // 限制在屏幕內
                lastPos = {x: note.x, y: note.y};
            });
            this.activeNote = null; this.gameArea.innerHTML = '';
            
            this.addListeners();
            Game.util.playAudio();
        },
        addListeners() {
            this.boundOnPointerDown = this.onPointerDown.bind(this);
            this.boundOnPointerMove = this.onPointerMove.bind(this);
            this.boundOnPointerUp = this.onPointerUp.bind(this);
            this.gameArea.addEventListener('pointerdown', this.boundOnPointerDown);
            window.addEventListener('pointermove', this.boundOnPointerMove);
            window.addEventListener('pointerup', this.boundOnPointerUp);
        },
        removeListeners() {
            this.gameArea.removeEventListener('pointerdown', this.boundOnPointerDown);
            window.removeEventListener('pointermove', this.boundOnPointerMove);
            window.removeEventListener('pointerup', this.boundOnPointerUp);
        },
        onPointerDown(e) { this.isPointerDown = true; this.updatePointerPos(e); },
        onPointerUp(e) { this.isPointerDown = false; },
        onPointerMove(e) {
            this.updatePointerPos(e);
            if (this.isPointerDown && Game.state.isPlaying) {
                const trail = document.createElement('div'); trail.className = 'trail';
                trail.style.left = `${this.pointerPos.x}px`; trail.style.top = `${this.pointerPos.y}px`;
                this.gameArea.appendChild(trail); setTimeout(() => trail.remove(), 500);
            }
        },
        updatePointerPos(e) { const touch = e.touches ? e.touches[0] : e; this.pointerPos.x = touch.clientX; this.pointerPos.y = touch.clientY; },
        gameLoop() {
            if (!Game.state.isPlaying) { Conductor.removeListeners(); return; }
            const elapsedTime = performance.now() - Game.state.startTime;

            if (!this.activeNote && this.noteQueue.length > 0 && elapsedTime >= this.noteQueue[0].time - 500) {
                this.spawnNote();
            }
            if (this.activeNote) {
                const noteData = this.activeNote.data;
                const dist = Math.hypot(this.pointerPos.x - this.activeNote.x, this.pointerPos.y - this.activeNote.y);
                if (this.isPointerDown && dist < this.activeNote.radius) this.judge('perfect');
                if (elapsedTime > noteData.time + 300 && this.activeNote && noteData.time === this.activeNote.data.time) this.judge('miss');
            }
            const songDuration = SongData.conductor[Game.state.currentSongId].duration;
            if (elapsedTime >= songDuration && !this.activeNote && this.noteQueue.length === 0) { Game.endGame(); return; }
            Game.state.animationFrameId = requestAnimationFrame(this.gameLoop.bind(this));
        },
        spawnNote() {
            const noteData = this.noteQueue.shift();
            const noteEl = document.createElement('div');
            noteEl.className = `note ${noteData.type || 'tap'}`;
            const x = noteData.x / 100 * window.innerWidth;
            const y = noteData.y / 100 * window.innerHeight;
            noteEl.style.left = `${x}px`; noteEl.style.top = `${y}px`;
            this.gameArea.appendChild(noteEl);
            setTimeout(() => noteEl.classList.add('active'), 50);
            this.activeNote = { element: noteEl, data: noteData, x, y, radius: noteEl.offsetWidth / 2 };
        },
        judge(type) {
            if (!this.activeNote) return;
            const isStrong = this.activeNote.data.type === 'strong';
            if (type === 'perfect') {
                Game.state.score += (isStrong ? 200 : 100) + Game.state.combo * 5;
                Game.state.hits.perfect++; Game.state.combo++;
                Game.util.showFeedback('perfect', '完美!');
            } else {
                Game.state.hits.miss++; Game.state.combo = 0;
                Game.util.showFeedback('miss', '錯過');
            }
            Game.state.maxCombo = Math.max(Game.state.maxCombo, Game.state.combo);
            this.activeNote.element.remove(); this.activeNote = null;
            Game.util.updateUI();
        }
    };
    
    const Turntable = {
        gameArea: document.getElementById('turntable-game-area'),
        recordEl: document.querySelector('#turntable-game-area .record'),
        tonearmEl: document.querySelector('#turntable-game-area .tonearm'),
        labelTitle: document.querySelector('#turntable-game-area .record-label .song-title'),
        labelArtist: document.querySelector('#turntable-game-area .record-label .song-artist'),
        isDragging: false, noteQueue: [], activeNotes: [],
        start() {
            this.isDragging = false;
            const songData = SongData.turntable[Game.state.currentSongId];
            this.noteQueue = JSON.parse(JSON.stringify(songData.notes));
            this.activeNotes = [];
            this.recordEl.innerHTML = '';
            
            const label = document.createElement('div');
            label.className = 'record-label';
            label.innerHTML = `<div class="song-title">${songData.title}</div><div class="song-artist">${songData.artist}</div>`;
            this.recordEl.appendChild(label);
            
            this.addListeners();
            this.recordEl.style.animationPlayState = 'running';
            Game.util.playAudio();
        },
        addListeners() {
            this.boundOnDragStart = this.onDragStart.bind(this);
            this.boundOnDragMove = this.onDragMove.bind(this);
            this.boundOnDragEnd = this.onDragEnd.bind(this);
            this.tonearmEl.addEventListener('pointerdown', this.boundOnDragStart);
            window.addEventListener('pointermove', this.boundOnDragMove);
            window.addEventListener('pointerup', this.boundOnDragEnd);
        },
        removeListeners() {
            this.tonearmEl.removeEventListener('pointerdown', this.boundOnDragStart);
            window.removeEventListener('pointermove', this.boundOnDragMove);
            window.removeEventListener('pointerup', this.boundOnDragEnd);
        },
        onDragStart(e) { this.isDragging = true; e.preventDefault(); },
        onDragEnd(e) { this.isDragging = false; },
        onDragMove(e) {
            if (!this.isDragging) return;
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const rect = this.gameArea.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const angle = Math.atan2(touch.clientY - centerY, touch.clientX - centerX) * (180 / Math.PI);
            this.tonearmEl.style.transform = `rotate(${angle}deg)`;
        },
        gameLoop() {
            if (!Game.state.isPlaying) { Turntable.removeListeners(); return; }
            const elapsedTime = performance.now() - Game.state.startTime;
            const recordCycle = 10000; // 10s per spin

            if (this.noteQueue.length > 0 && elapsedTime >= this.noteQueue[0].time - recordCycle / 4) {
                this.spawnNote(this.noteQueue.shift());
            }

            const style = window.getComputedStyle(this.tonearmEl);
            const matrix = new DOMMatrixReadOnly(style.transform);
            const tonearmAngle = Math.round(Math.atan2(matrix.b, matrix.a) * (180 / Math.PI));
            
            this.activeNotes.forEach(noteObj => {
                if (elapsedTime >= noteObj.time - 150 && elapsedTime <= noteObj.time + 150) {
                    if (tonearmAngle > -100 && tonearmAngle < -80) { // Judgment zone around -90deg
                        this.judge('perfect', noteObj);
                    } else if (tonearmAngle > -110 && tonearmAngle < -70) {
                         this.judge('good', noteObj);
                    }
                }
                if (elapsedTime > noteObj.time + 150) {
                    this.judge('miss', noteObj);
                }
            });

            this.activeNotes = this.activeNotes.filter(n => !n.judged);
            
            const songDuration = SongData.turntable[Game.state.currentSongId].duration;
            if (elapsedTime >= songDuration && this.activeNotes.length === 0 && this.noteQueue.length === 0) {
                this.recordEl.style.animationPlayState = 'paused';
                Game.endGame();
                return;
            }
            Game.state.animationFrameId = requestAnimationFrame(this.gameLoop.bind(this));
        },
        spawnNote(noteData) {
            const noteEl = document.createElement('div');
            noteEl.className = `note ${noteData.type || 'tap'}`;
            noteEl.style.transform = `rotate(-90deg)`;
            this.recordEl.appendChild(noteEl);
            this.activeNotes.push({ element: noteEl, time: noteData.time, type: noteData.type, judged: false });
        },
        judge(type, noteObj) {
            if (noteObj.judged) return;
            noteObj.judged = true;
            noteObj.element.remove();
            
            const isStrong = noteObj.type === 'strong';
            if (type === 'perfect') {
                Game.state.score += (isStrong ? 200 : 100) + Game.state.combo * 5; Game.state.hits.perfect++; Game.state.combo++;
                Game.util.showFeedback('perfect', 'Perfect!');
            } else if (type === 'good') {
                Game.state.score += (isStrong ? 100 : 50); Game.state.hits.good++; Game.state.combo++;
                Game.util.showFeedback('good', 'Good');
            } else {
                Game.state.hits.miss++; Game.state.combo = 0;
                Game.util.showFeedback('miss', 'Miss');
            }
            Game.state.maxCombo = Math.max(Game.state.maxCombo, Game.state.combo);
            Game.util.updateUI();
        }
    };
    
    // --- 5. 教學模組 ---
    const Tutorial = {
        container: document.getElementById('tutorial-content'),
        timer: null, step: 0,
        start() { this.step = 0; this.runStep(); this.timer = setInterval(this.runStep.bind(this), 4000); },
        stop() { clearInterval(this.timer); },
        runStep() {
            this.container.innerHTML = ''; // 清空
            const demos = [this.demoTimeBeat, this.demoConductor, this.demoTurntable];
            demos[this.step % demos.length].call(this);
            this.step++;
        },
        demoTimeBeat() {
            const item = document.createElement('div');
            item.className = 'tutorial-item active';
            item.innerHTML = `<p style="font-size:1.2rem; margin-top: 150px;"><b>時光節拍:</b><br>在音符到達下方判定區時點擊！</p>`;
            const note = document.createElement('div');
            note.className = 'demo-note';
            note.style = `width:50px; height:50px; left:50%; top:10%;`;
            item.appendChild(note); this.container.appendChild(item);
            note.animate([{ top: '10%' }, { top: '85%' }], { duration: 1500, easing: 'linear' });
        },
        demoConductor() {
            const item = document.createElement('div');
            item.className = 'tutorial-item active';
            item.innerHTML = `<p style="font-size:1.2rem; margin-top: 150px;"><b>指揮家:</b><br>跟隨光流，在音符上滑動或點擊！</p>`;
            const finger = document.createElement('div');
            finger.className = 'demo-finger';
            item.appendChild(finger); this.container.appendChild(item);
            finger.animate([
                { left: '20%', top: '50%' }, { left: '80%', top: '40%' }, { left: '50%', top: '70%' }
            ], { duration: 3000, iterations: Infinity, direction: 'alternate', easing: 'ease-in-out' });
        },
        demoTurntable() {
            const item = document.createElement('div');
            item.className = 'tutorial-item active';
            item.innerHTML = `<p style="font-size:1.2rem; margin-top: 150px;"><b>時光唱盤:</b><br>拖動唱臂，對準頂部判定區！</p>`;
            const finger = document.createElement('div');
            finger.className = 'demo-finger';
            finger.style = `width: 80px; height: 10px; border-radius: 5px; background: #eee; transform-origin: 70px center; left: 50%; top: 50%;`;
            item.appendChild(finger); this.container.appendChild(item);
            finger.animate([ { transform: 'rotate(-60deg)' }, { transform: 'rotate(-120deg)' } ], 
            { duration: 3000, iterations: Infinity, direction: 'alternate', easing: 'ease-in-out' });
        }
    };
    
    // --- 6. 最終初始化 ---
    Game.init();
    </script>
</body>
</html>
