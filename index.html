<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ™‚å…‰è¿´å»Š - æ‡·èˆŠéŸ³æ¨‚ä¹‹æ—…</title>
    <style>
        /* CSSæ¨£å¼èˆ‡ä¹‹å‰ç›¸åŒï¼Œæ­¤è™•ç‚ºç¯€çœç¯‡å¹…çœç•¥... */
        /* --- å…¨å±€èˆ‡ä½ˆå±€ --- */
        :root {
            --record-size: 300px;
            --theme-color-1: #ff8c00; /* æº«æš–çš„æ©™è‰² */
            --theme-color-2: #483d8b; /* æ‡·èˆŠçš„æš—è—è‰² */
            --font-family: 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            overflow: hidden;
            touch-action: none;
            background: linear-gradient(135deg, #2a2a3e, #4a3a4a);
            color: white;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none;
        }
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none; /* é»˜èªå…¨éƒ¨éš±è— */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            text-align: center;
            box-sizing: border-box;
            padding: 20px;
        }
        .screen.active {
            display: flex;
        }
        .retro-button {
            padding: 12px 28px;
            font-size: 18px;
            color: white;
            background: linear-gradient(145deg, var(--theme-color-1), #e06a00);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 0 #a04a00, 2px 2px 8px rgba(0,0,0,0.5);
            transition: all 0.1s ease-out;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .retro-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #a04a00;
        }
        h1 { font-size: 42px; text-shadow: 2px 2px 8px rgba(0,0,0,0.8); }
        p { opacity: 0.9; }

        /* --- ä¸»é¸å–® (æ™‚å…‰è¿´å»Š) --- */
        #main-menu-screen {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://source.unsplash.com/random/800x600/?city,night,80s') no-repeat center center/cover;
        }
        #main-menu-screen h1 { font-size: 48px; }
        .game-choice-container { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 30px; }
        .game-choice-card {
            width: 140px;
            height: 180px;
            margin: 15px;
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            background: rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .game-choice-card:hover { transform: scale(1.05); border-color: var(--theme-color-1); }
        .game-choice-card .icon { font-size: 50px; }
        .game-choice-card .title { font-size: 22px; margin-top: 15px; font-weight: bold; }

        /* --- ç©æ³•ç¤ºç¯„ --- */
        #tutorial-screen .tutorial-container { position: relative; width: 300px; height: 400px; border: 2px dashed #fff; border-radius: 10px; background: rgba(0,0,0,0.2); }
        #tutorial-screen p { margin: 15px 0 25px 0; font-size: 18px; }
        .tutorial-item { position: absolute; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .tutorial-item.active { opacity: 1; }
        .demo-finger {
            width: 40px; height: 40px; background-color: rgba(255, 255, 100, 0.8); border-radius: 50%;
            position: absolute; box-shadow: 0 0 15px white; z-index: 100;
        }
        .demo-note { width: 50px; height: 50px; border-radius: 50%; background: #ffd700; display:flex; justify-content:center; align-items:center; }
        .demo-note-strong { width: 65px; height: 65px; background: #ff4500; }
        .demo-judgment-line { position: absolute; bottom: 50px; width: 80%; height: 3px; background: var(--theme-color-1); border-radius: 3px; }
        @keyframes demo-tap { 0% {transform: scale(1);} 20% {transform: scale(0.8);} 40% {transform: scale(1);} 100% {transform: scale(1);} }
        @keyframes demo-move { from { top: 20%; } to { top: 80%; } }
        @keyframes demo-drag { from { transform: rotate(-30deg); } to { transform: rotate(30deg); } }

        /* --- æ­Œæ›²é¸æ“‡ --- */
        #song-selection-screen { backdrop-filter: blur(10px); }
        #song-list { width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto; padding-top: 10px; }
        .song-choice {
            background-color: rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px;
            padding: 15px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .song-choice:not(.locked):hover { border-color: var(--theme-color-1); transform: scale(1.02); }
        .song-choice.locked { cursor: not-allowed; background-color: rgba(0,0,0,0.5); color: #888; }
        .song-title { font-size: 20px; font-weight: bold; }
        .song-artist { font-size: 14px; opacity: 0.8; margin-top: 5px; }
        .song-highscore, .song-unlock-condition { font-size: 12px; margin-top: 8px; color: var(--theme-color-1); }
        .lock-icon { font-size: 28px; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); opacity: 0.7; }

        /* --- éŠæˆ²é€šç”¨ UI --- */
        .game-ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; pointer-events: none;
        }
        .game-ui-container.active { display: block; }
        .game-stats {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; font-size: 24px;
            color: white; text-shadow: 1px 1px 3px black; pointer-events: auto;
        }
        .feedback-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 101;
        }
        .feedback {
            font-size: 48px; font-weight: bold;
            opacity: 0; animation: feedback-anim 1s forwards;
        }
        .feedback.perfect { color: #ffd700; }
        .feedback.miss { color: #ff69b4; }
        .first-play-hint {
            position: absolute; background-color: rgba(0,0,0,0.8); padding: 10px 15px; border-radius: 8px;
            color: white; font-size: 16px; pointer-events: none; z-index: 200;
            text-shadow: 1px 1px 2px black;
            animation: pulse 2s infinite;
        }

        /* --- æŒ‡æ®å®¶ éŠæˆ²æ¨£å¼ --- */
        #conductor-game-area { width: 100vw; height: 100vh; cursor: crosshair; pointer-events: auto; }
        #conductor-game-area .note { position: absolute; width: 50px; height: 50px; border-radius: 50%; transform: translate(-50%, -50%) scale(0); transition: transform 0.3s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.3); border: 2px solid rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; }
        #conductor-game-area .note.active { transform: translate(-50%, -50%) scale(1); background-color: rgba(255, 215, 0, 0.5); border-color: #ffd700; animation: pulse 1.5s infinite; }
        #conductor-game-area .note.strong.active { transform: translate(-50%, -50%) scale(1.3); background-color: rgba(255, 100, 100, 0.7); border-color: #ff4500; }
        #conductor-game-area .note.hold.active::after { content: ''; position: absolute; width: 100%; height: 100%; border: 4px solid #1e90ff; border-radius: 50%; animation: shrink var(--duration) linear forwards; }
        #conductor-game-area .trail { position: absolute; width: 20px; height: 20px; background: radial-gradient(circle, rgba(255, 223, 186, 0.8) 0%, rgba(255, 223, 186, 0) 70%); border-radius: 50%; transform: translate(-50%, -50%); z-index: 5; pointer-events: none; animation: fade-out 0.5s forwards; }

        /* --- æ™‚å…‰å”±ç›¤ éŠæˆ²æ¨£å¼ --- */
        #turntable-game-area { width: 100%; height: 100%; display:flex; justify-content:center; align-items:center; }
        #turntable-container { position: relative; width: var(--record-size); height: var(--record-size); }
        #turntable-container #record { width: 100%; height: 100%; background: radial-gradient(circle, #555 10%, #444 11%, #333 12%, #333 100%); border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: spin 10s linear infinite; animation-play-state: paused; }
        #turntable-container #record::before { content: ''; position: absolute; width: 90%; height: 90%; border-radius: 50%; background-image: repeating-radial-gradient(circle, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 1px, transparent 1px, transparent 4px); }
        #turntable-container #record-label { width: 35%; height: 35%; background-color: #d2b48c; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 11px; color: #5d4037; font-weight: bold; z-index: 1; border: 2px solid #a1887f; padding: 5px; box-sizing: border-box; }
        #turntable-container #judgment-zone { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; border: 2px solid rgba(255, 223, 186, 0.7); border-radius: 50%; z-index: 10; background: rgba(255,223,186,0.2); }
        #turntable-container .note { position: absolute; width: 40px; height: 10px; background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.8), transparent); border-radius: 5px; transform-origin: 50% calc(var(--record-size) / 2); top: 50%; left: 50%; margin-top:-5px; margin-left:-20px; z-index: 5; }
        #turntable-container .note.strong { background: linear-gradient(90deg, transparent, rgba(255, 100, 100, 1), transparent); box-shadow: 0 0 10px #ff4500; height: 14px; margin-top:-7px; }

        /* --- æ™‚å…‰ç¯€æ‹ éŠæˆ²æ¨£å¼ --- */
        #timebeat-game-area { width: 100%; height: 100%; pointer-events: auto; }
        #timebeat-game-area #judgment-line-container { position:absolute; bottom: 15%; left:0; width:100%; display:flex; justify-content:center; }
        #timebeat-game-area #judgment-line { width: 90%; max-width: 400px; height: 5px; background: linear-gradient(90deg, transparent, var(--theme-color-1), transparent); box-shadow: 0 0 15px var(--theme-color-1); border-radius: 5px; }
        #timebeat-game-area .note { position: absolute; top: -50px; width: 80px; height: 30px; background: #ffd700; border-radius: 15px; transform: translateX(-50%); transition: top 1.5s linear; }
        #timebeat-game-area .note.strong { background: #ff4500; box-shadow: 0 0 10px #ff4500; height: 40px; }
        
        /* --- çµæŸèˆ‡æ’è¡Œæ¦œç•«é¢ --- */
        #end-screen-content { padding: 20px; }
        #leaderboard-screen input {
            width: 100px; font-size: 24px; text-align: center; background: #333; color: white; border: 2px solid #ccc;
            border-radius: 5px; margin: 10px 0; text-transform: uppercase;
        }
        #leaderboard-list { list-style: none; padding: 0; width: 80%; max-width: 350px; margin-top: 20px; }
        #leaderboard-list li {
            display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px;
            background: rgba(255,255,255,0.1); border-radius: 5px;
        }
        #leaderboard-list li:first-child { background: var(--theme-color-1); font-weight: bold; }

        /* --- å‹•ç•« --- */
        @keyframes pulse { 0% { box-shadow: 0 0 10px #ffd700; } 50% { box-shadow: 0 0 25px #ffd700; } 100% { box-shadow: 0 0 10px #ffd700; } }
        @keyframes shrink { from { transform: scale(1.5); opacity: 1; } to { transform: scale(1); opacity: 0; } }
        @keyframes fade-out { to { transform: translate(-50%, -50%) scale(0); opacity: 0; } }
        @keyframes feedback-anim { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="conductor-game-area" class="game-ui-container"></div>
        <div id="turntable-game-area" class="game-ui-container">
            <div id="turntable-container">
                <div id="judgment-zone"></div>
                <div id="record"><div id="record-label"><div class="song-title"></div><div class="song-artist"></div></div></div>
            </div>
        </div>
        <div id="timebeat-game-area" class="game-ui-container">
            <div id="judgment-line-container">
                 <div id="judgment-line"></div>
            </div>
        </div>
        
        <div class="game-stats" style="display: none;">
            <div>å¾—åˆ†: <span id="score">0</span></div>
            <div>é€£æ“Š: <span id="combo">0</span></div>
        </div>
        <div class="feedback-container"></div>
    </div>

    <div id="main-menu-screen" class="screen active">
        <h1>æ™‚å…‰è¿´å»Š</h1>
        <p>é¸æ“‡ä½ çš„æ‡·èˆŠéŸ³æ¨‚ä¹‹æ—…</p>
        <div class="game-choice-container">
            <div class="game-choice-card" data-gametype="conductor">
                <div class="icon">ğŸ¼</div>
                <div class="title">æŒ‡æ®å®¶</div>
            </div>
            <div class="game-choice-card" data-gametype="turntable">
                <div class="icon">ğŸ’¿</div>
                <div class="title">æ™‚å…‰å”±ç›¤</div>
            </div>
            <div class="game-choice-card" data-gametype="timebeat">
                <div class="icon">ğŸ¹</div>
                <div class="title">æ™‚å…‰ç¯€æ‹</div>
            </div>
        </div>
        <button class="retro-button" id="show-tutorial-btn" style="margin-top: 30px;">è§€çœ‹ç©æ³•</button>
    </div>

    <div id="tutorial-screen" class="screen">
        <h1 id="tutorial-title">ç©æ³•ç¤ºç¯„</h1>
        <p id="tutorial-desc">é»æ“Šå±å¹•ç¹¼çºŒ</p>
        <div class="tutorial-container">
            </div>
        <button class="retro-button" id="skip-tutorial-btn">ç•¥éç¤ºç¯„</button>
    </div>

    <div id="song-selection-screen" class="screen">
        <h1 id="song-selection-title">é¸æ“‡æ›²ç›®</h1>
        <div id="song-list"></div>
        <button class="retro-button" id="back-to-main-menu-btn">è¿”å›ä¸»é¸å–®</button>
    </div>

    <div id="end-screen" class="screen">
        <div id="end-screen-content">
            <h1 id="end-title">æ¼”å¥çµæŸ</h1>
            <p style="font-size: 24px;">æœ€çµ‚å¾—åˆ†: <span id="final-score">0</span></p>
            <p>æœ€é«˜é€£æ“Š: <span id="max-combo">0</span></p>
            <p>è©•ç´š: <span id="rating-badge"></span></p>
            <button id="view-leaderboard-btn" class="retro-button">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
            <button id="retry-button" class="retro-button">å†æ¬¡å˜—è©¦</button>
            <button id="back-to-song-menu-btn" class="retro-button">è¿”å›é¸æ›²</button>
        </div>
    </div>
    
    <div id="leaderboard-screen" class="screen">
        <h1 id="leaderboard-title">æ­Œæ›²æ’è¡Œæ¦œ</h1>
        <div id="name-prompt" style="display: none;">
            <h3>æ­å–œå‰µä¸‹æ–°ç´€éŒ„ï¼è«‹ç•™ä¸‹ä½ çš„å¤§åï¼š</h3>
            <input type="text" id="player-name-input" maxlength="3" value="AAA">
            <button id="submit-score-btn" class="retro-button">æäº¤åˆ†æ•¸</button>
        </div>
        <ol id="leaderboard-list"></ol>
        <button class="retro-button" id="back-from-leaderboard-btn">è¿”å›</button>
    </div>

    <script>
    // =================================================================================
    //  æ™‚å…‰è¿´å»Š H5 éŠæˆ² - çµ±ä¸€ç¨‹å¼ç¢¼æ¡†æ¶ (å‹•æ…‹è¼‰å…¥ç‰ˆ)
    // =================================================================================

    // --- å…¨å±€ DOM ç²å– ---
    const allScreens = document.querySelectorAll('.screen');
    const gameUIs = document.querySelectorAll('.game-ui-container');
    const gameStatsEl = document.querySelector('.game-stats');
    const feedbackContainer = document.querySelector('.feedback-container');

    // --- éŸ³è¨Šç®¡ç†å™¨ ---
    const AudioManager = {
        sounds: {},
        bgm: null,
        preload() {
            this.sounds.hit = new Audio('/audio/hit.wav');
            this.sounds.miss = new Audio('/audio/miss.wav');
            
            // è™•ç†ç€è¦½å™¨éŸ³è¨Šè‡ªå‹•æ’­æ”¾æ”¿ç­–
            const initAudio = () => {
                Object.values(this.sounds).forEach(sound => {
                    sound.play().catch(() => {});
                    sound.pause();
                });
                window.removeEventListener('click', initAudio, true);
                window.removeEventListener('touchstart', initAudio, true);
            };
            window.addEventListener('click', initAudio, true);
            window.addEventListener('touchstart', initAudio, true);
        },
        play(soundName) {
            const sound = this.sounds[soundName];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.error("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e));
            }
        },
        playBGM(audioFile) {
            this.stopBGM();
            const bgmPath = `/audio/${audioFile}`;
            this.bgm = new Audio(bgmPath);
            this.bgm.loop = true;
            this.bgm.play().catch(e => console.error(`BGM ${bgmPath} æ’­æ”¾å¤±æ•—:`, e));
        },
        stopBGM() {
            if (this.bgm) {
                this.bgm.pause();
                this.bgm = null;
            }
        }
    };
    
    // --- éŠæˆ²ç‹€æ…‹ç®¡ç†å™¨ ---
    const Game = {
        state: { /* ... */ },
        init() { /* ... */ },
        showScreen(screenId) { /* ... */ },
        async startGame(songId) { // *** æ”¹ç‚ºç•°æ­¥å‡½æ•¸ ***
            this.state.currentSongId = songId;
            const gameType = this.state.activeGame;
            const songData = SongData[gameType][songId];
            
            // é¡¯ç¤ºè®€å–ä¸­... (å¯é¸)
            this.showScreen('loading-screen'); // å‡è¨­æœ‰ä¸€å€‹è®€å–ç•«é¢

            try {
                // å¾ /beatmaps/ å‹•æ…‹è¼‰å…¥è­œé¢
                const response = await fetch(`/beatmaps/${songData.beatmapFile}`);
                if (!response.ok) throw new Error(`æ‰¾ä¸åˆ°è­œé¢æª”æ¡ˆ: ${songData.beatmapFile}`);
                const notes = await response.json();

                // è­œé¢è¼‰å…¥æˆåŠŸå¾Œï¼Œæ‰æ­£å¼é–‹å§‹éŠæˆ²
                this.state.score = 0;
                this.state.combo = 0;
                this.state.maxCombo = 0;
                this.state.isPlaying = true;

                allScreens.forEach(s => s.classList.remove('active'));
                gameUIs.forEach(ui => ui.classList.remove('active'));
                document.getElementById(`${gameType}-game-area`).classList.add('active');
                gameStatsEl.style.display = 'flex';
                this.updateUI();

                // æ’­æ”¾BGM
                AudioManager.playBGM(songData.audioFile);

                // å•Ÿå‹•å°æ‡‰çš„éŠæˆ²é‚è¼¯ï¼Œä¸¦å‚³å…¥è­œé¢
                const GameImplementations = { conductor: Conductor, turntable: Turntable, timebeat: TimeBeat };
                GameImplementations[gameType].start(notes, songData);
                
                // é¦–æ¬¡éŠç©æç¤º
                if (this.state.isFirstPlay[gameType]) {
                    this.showFirstPlayHint();
                    this.state.isFirstPlay[gameType] = false;
                    localStorage.setItem('isFirstPlay', JSON.stringify(this.state.isFirstPlay));
                }

            } catch (error) {
                console.error("ç„¡æ³•é–‹å§‹éŠæˆ²:", error);
                alert(`éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥æ­Œæ›²è³‡æºã€‚\n${error.message}`);
                this.showScreen('song-selection-screen'); // è¿”å›é¸æ­Œç•«é¢
            }
        },
        endGame() { /* ... */ },
        updateUI() { /* ... */ },
        showFeedback(type, text) { /* ... */ },
        showFirstPlayHint() { /* ... */ },
    };
    // ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œéƒ¨åˆ†æœªè®Šå‹•çš„å‡½æ•¸å…§å®¹ç”¨ /* ... */ è¡¨ç¤º
    Object.assign(Game, {
        state: {
            activeGame: null,
            currentSongId: null,
            score: 0,
            combo: 0,
            maxCombo: 0,
            isPlaying: false,
            isFirstPlay: { conductor: true, turntable: true, timebeat: true },
            gameLoopId: null
        },
        init() {
            document.querySelectorAll('.game-choice-card').forEach(card => {
                card.addEventListener('click', () => {
                    this.state.activeGame = card.dataset.gametype;
                    this.showScreen('song-selection-screen');
                    SongSelection.render();
                });
            });
            document.getElementById('show-tutorial-btn').addEventListener('click', () => Tutorial.start());
            document.getElementById('back-to-main-menu-btn').addEventListener('click', () => this.showScreen('main-menu-screen'));
            document.getElementById('retry-button').addEventListener('click', () => this.startGame(this.state.currentSongId));
            document.getElementById('back-to-song-menu-btn').addEventListener('click', () => {
                this.showScreen('song-selection-screen');
                SongSelection.render();
            });
            document.getElementById('view-leaderboard-btn').addEventListener('click', () => Leaderboard.show());

            const savedFirstPlay = localStorage.getItem('isFirstPlay');
            if (savedFirstPlay) { this.state.isFirstPlay = JSON.parse(savedFirstPlay); }
            this.showScreen('main-menu-screen');
        },
        showScreen(screenId) {
            allScreens.forEach(s => s.classList.remove('active'));
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.add('active');
        },
        endGame() {
            if (!this.state.isPlaying) return;
            AudioManager.stopBGM();
            this.state.isPlaying = false;
            if (this.state.gameLoopId) cancelAnimationFrame(this.state.gameLoopId);
            gameStatsEl.style.display = 'none';

            const songData = SongData[this.state.activeGame][this.state.currentSongId];
            const maxPossibleScore = (songData.noteCount || 1) * 350; // noteCount æ‡‰åœ¨è¼‰å…¥è­œé¢æ™‚è¨ˆç®—
            const scoreRatio = maxPossibleScore > 0 ? this.state.score / maxPossibleScore : 0;
            let rating = 'C';
            if (scoreRatio >= 0.9) rating = 'S';
            else if (scoreRatio >= 0.8) rating = 'A';
            else if (scoreRatio >= 0.6) rating = 'B';
            
            document.getElementById('end-title').textContent = `ã€Š${songData.title}ã€‹`;
            document.getElementById('final-score').textContent = this.state.score;
            document.getElementById('max-combo').textContent = this.state.maxCombo;
            document.getElementById('rating-badge').textContent = rating;

            this.showScreen('end-screen');
            Leaderboard.checkNewScore(this.state.score);
        },
        updateUI() {
            document.getElementById('score').textContent = Game.state.score;
            document.getElementById('combo').textContent = Game.state.combo;
        },
        showFeedback(type, text) {
            const feedbackEl = document.createElement('div');
            feedbackEl.className = `feedback ${type}`;
            feedbackEl.textContent = text;
            feedbackContainer.innerHTML = '';
            feedbackContainer.appendChild(feedbackEl);
        },
        showFirstPlayHint() {
            const hints = {
                conductor: { text: 'é»æ“Šæˆ–æŒ‰ä½éŸ³ç¬¦ï¼', style: { top: '30%', left: '50%', transform: 'translateX(-50%)' } },
                turntable: { text: 'é»æ“Šè½‰å‹•çš„å”±ç‰‡ï¼', style: { top: '25%', left: '50%', transform: 'translateX(-50%)' } },
                timebeat: { text: 'åœ¨ç¯€æ‹é»æ“Šä¸‹è½çš„éŸ³ç¬¦ï¼', style: { bottom: '25%', left: '50%', transform: 'translateX(-50%)' } }
            };
            const hintData = hints[this.state.activeGame];
            const hintEl = document.createElement('div');
            hintEl.className = 'first-play-hint';
            hintEl.textContent = hintData.text;
            Object.assign(hintEl.style, hintData.style);
            
            const gameArea = document.getElementById(`${this.state.activeGame}-game-area`);
            gameArea.appendChild(hintEl);
            setTimeout(() => hintEl.remove(), 4000);
        }
    });

    // --- æ­Œæ›²æ•¸æ“š (æŒ‡å‘æª”æ¡ˆï¼Œä¸å†åŒ…å«è­œé¢) ---
    const SongData = {
        conductor: {
            song1: { title: 'ç”·å…’ç•¶è‡ªå¼·', artist: 'æ—å­ç¥¥', unlockScore: 0, duration: 19100, beatmapFile: 'conductor_song1.json', audioFile: 'conductor_song1.mp3' },
            song2: { title: 'æœˆäº®ä»£è¡¨æˆ‘çš„å¿ƒ', artist: 'é„§éº—å›', unlockScore: 2000, duration: 17000, beatmapFile: 'conductor_song2.json', audioFile: 'conductor_song2.mp3' }
        },
        turntable: {
            song1: { title: 'ç”œèœœèœœ', artist: 'é„§éº—å›', unlockScore: 0, duration: 21000, beatmapFile: 'turntable_song1.json', audioFile: 'turntable_song1.mp3' },
            song2: { title: 'ç€Ÿç‘èµ°ä¸€å›', artist: 'è‘‰è’¨æ–‡', unlockScore: 2500, duration: 18000, beatmapFile: 'turntable_song2.json', audioFile: 'turntable_song2.mp3' }
        },
        timebeat: {
            song1: { title: 'ç«¥å¹´', artist: 'ç¾…å¤§ä½‘', unlockScore: 0, duration: 19300, beatmapFile: 'timebeat_song1.json', audioFile: 'timebeat_song1.mp3' },
            song2: { title: 'å¾ˆæ„›å¾ˆæ„›ä½ ', artist: 'åŠ‰è‹¥è‹±', unlockScore: 1800, duration: 17000, beatmapFile: 'timebeat_song2.json', audioFile: 'timebeat_song2.mp3' }
        }
    };
    
    // --- æ­Œæ›²é¸æ“‡ã€æ’è¡Œæ¦œã€æ•™å­¸æ¨¡çµ„ (èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œçœç•¥ä»¥ç¯€çœç¯‡å¹…) ---
    const SongOrder = { /* ... */ };
    const SongSelection = { /* ... */ };
    const Leaderboard = { /* ... */ };
    const Tutorial = { /* ... */ };
    Object.assign(SongOrder, { conductor: ['song1', 'song2'], turntable: ['song1', 'song2'], timebeat: ['song1', 'song2'] });
    SongSelection.render = function() {
        const gameType = Game.state.activeGame;
        const titles = { conductor: 'æŒ‡æ®æ¨‚ç« ', turntable: 'æ™‚å…‰é‡‘æ›²', timebeat: 'ç¯€æ‹æƒ…æ‡·' };
        document.getElementById('song-selection-title').textContent = titles[gameType];
        const songListContainer = document.getElementById('song-list');
        songListContainer.innerHTML = '';
        const playerProgress = Leaderboard.playerProgress;
        
        (SongOrder[gameType] || []).forEach((songId, index) => {
            const song = SongData[gameType][songId];
            const prevSongId = index > 0 ? SongOrder[gameType][index - 1] : null;
            const isUnlocked = !prevSongId || (playerProgress[gameType][prevSongId] || 0) >= song.unlockScore;

            const songEl = document.createElement('div');
            songEl.className = 'song-choice' + (isUnlocked ? '' : ' locked');

            if (isUnlocked) {
                const highscore = playerProgress[gameType][songId] ? `<div class="song-highscore">æœ€é«˜åˆ†: ${playerProgress[gameType][songId]}</div>` : '';
                songEl.innerHTML = `<div class="song-title">${song.title}</div><div class="song-artist">${song.artist}</div>${highscore}`;
                songEl.addEventListener('click', () => Game.startGame(songId));
            } else {
                const prevSongTitle = SongData[gameType][prevSongId].title;
                songEl.innerHTML = `
                    <div class="song-title">${song.title}</div><div class="song-artist">${song.artist}</div>
                    <div class="song-unlock-condition">å®Œæˆã€Š${prevSongTitle}ã€‹ä¸¦ç²å¾— ${song.unlockScore} åˆ†</div>
                    <div class="lock-icon">ğŸ”’</div>`;
            }
            songListContainer.appendChild(songEl);
        });
    };
    Object.assign(Leaderboard, {
        playerProgress: { conductor: {}, turntable: {}, timebeat: {} },
        leaderboards: { conductor: {}, turntable: {}, timebeat: {} },
        init() {
            try {
                const savedProgress = localStorage.getItem('playerProgress');
                if (savedProgress) this.playerProgress = JSON.parse(savedProgress);
                const savedBoards = localStorage.getItem('leaderboards');
                if (savedBoards) this.leaderboards = JSON.parse(savedBoards);
            } catch (e) { console.error("ç„¡æ³•è®€å–å­˜æª”:", e); }

            ['conductor', 'turntable', 'timebeat'].forEach(game => {
                if (!this.playerProgress[game]) this.playerProgress[game] = {};
                if (!this.leaderboards[game]) this.leaderboards[game] = {};
            });

            document.getElementById('submit-score-btn').addEventListener('click', () => this.submitScore());
            document.getElementById('back-from-leaderboard-btn').addEventListener('click', () => Game.showScreen('end-screen'));
        },
        getScores(game, song) {
            if (!this.leaderboards[game][song]) this.leaderboards[game][song] = [];
            return this.leaderboards[game][song];
        },
        addScore(game, song, name, score) {
            const scores = this.getScores(game, song);
            scores.push({ name, score });
            scores.sort((a, b) => b.score - a.score);
            this.leaderboards[game][song] = scores.slice(0, 5);
            this.save();
        },
        checkNewScore(score) {
            const game = Game.state.activeGame;
            const song = Game.state.currentSongId;
            const scores = this.getScores(game, song);
            if (scores.length < 5 || score > (scores[scores.length - 1].score || 0) ) {
                document.getElementById('name-prompt').style.display = 'block';
            } else {
                document.getElementById('name-prompt').style.display = 'none';
            }
            const prevHighScore = this.playerProgress[game][song] || 0;
            if (score > prevHighScore) {
                this.playerProgress[game][song] = score;
                this.save();
            }
        },
        submitScore() {
            const name = document.getElementById('player-name-input').value.toUpperCase() || 'AAA';
            this.addScore(Game.state.activeGame, Game.state.currentSongId, name, Game.state.score);
            document.getElementById('name-prompt').style.display = 'none';
            this.render();
        },
        render() {
            const game = Game.state.activeGame;
            const song = Game.state.currentSongId;
            const songTitle = SongData[game][song].title;
            document.getElementById('leaderboard-title').textContent = `ã€Š${songTitle}ã€‹æ’è¡Œæ¦œ`;
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '';
            const scores = this.getScores(game, song);
            if (scores.length === 0) {
                listEl.innerHTML = '<li>æš«ç„¡è¨˜éŒ„ï¼Œå¿«ä¾†çˆ­å¥ªç¬¬ä¸€ï¼</li>';
            } else {
                scores.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>#${index + 1} ${entry.name}</span><span>${entry.score}</span>`;
                    listEl.appendChild(li);
                });
            }
        },
        show() {
            Game.showScreen('leaderboard-screen');
            this.render();
        },
        save() {
            try {
                localStorage.setItem('playerProgress', JSON.stringify(this.playerProgress));
                localStorage.setItem('leaderboards', JSON.stringify(this.leaderboards));
            } catch (e) { console.error("ç„¡æ³•å„²å­˜é€²åº¦:", e); }
        }
    });
    Tutorial.start = function() { /* Omitted */ }; // The tutorial logic remains the same

    // --- éŠæˆ²é‚è¼¯æ¨¡çµ„ (æ›´æ–°ç‚ºæ¥æ”¶è­œé¢) ---
    const Conductor = {
        // ... (å±¬æ€§å®šç¾©èˆ‡ä¹‹å‰ç›¸åŒ)
        start(notes, songData) { // *** æ¥æ”¶ notes å’Œ songData ***
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            this.activeNote = null;
            this.gameArea.innerHTML = '';
            this.startTime = Date.now();
            this.songDuration = songData.duration;
            Game.state.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
        },
        gameLoop() {
            // ... (å¤§éƒ¨åˆ†é‚è¼¯ç›¸åŒ)
            if (gameTime > this.songDuration && !this.activeNote && this.noteQueue.length === 0) {
                Game.endGame();
            } else {
                Game.state.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
            }
        },
        // ... (å…¶ä»–å‡½æ•¸ä¸è®Š)
    };
    const Turntable = {
        // ...
        start(notes, songData) { // *** æ¥æ”¶ notes å’Œ songData ***
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            // ... (å…¶é¤˜å•Ÿå‹•é‚è¼¯)
        },
        // ...
    };
    const TimeBeat = {
        // ...
        start(notes, songData) { // *** æ¥æ”¶ notes å’Œ songData ***
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            // ... (å…¶é¤˜å•Ÿå‹•é‚è¼¯)
        },
        // ...
    };
    // ç‚ºäº†å¯è®€æ€§ï¼Œæ­¤è™•åƒ…å±•ç¤ºä¿®æ”¹çš„éª¨æ¶ï¼Œå®Œæ•´é‚è¼¯è«‹åƒè€ƒä¸Šä¸€ç‰ˆã€‚
    // åªéœ€å°‡æ‰€æœ‰ start() æ”¹ç‚º start(notes, songData) ä¸¦èª¿æ•´è­œé¢ä¾†æºå³å¯ã€‚
    // ä»¥ä¸‹ç‚º Conductor çš„å®Œæ•´æ›¿æ›ç¯„ä¾‹ï¼š
    Object.assign(Conductor, {
        gameArea: document.getElementById('conductor-game-area'),
        pointerPos: { x: 0, y: 0 }, isPointerDown: false, startTime: 0, songDuration: 0,
        noteQueue: [], activeNote: null, holdTimer: null,
        start(notes, songData) {
            this.noteQueue = JSON.parse(JSON.stringify(notes));
            this.activeNote = null;
            this.gameArea.innerHTML = '';
            this.startTime = Date.now();
            this.songDuration = songData.duration;
            Game.state.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
        },
        gameLoop() { /* ... unchanged ... */ },
        spawnNote() { /* ... unchanged ... */ },
        judge(type) { /* ... unchanged ... */ },
        onPointerDown(e) { this.isPointerDown = true; this.updatePointerPos(e); },
        onPointerUp(e) { /* ... unchanged ... */ },
        onPointerMove(e) { /* ... unchanged ... */ },
        updatePointerPos(e) { const touch = e.touches ? e.touches[0] : e; this.pointerPos.x = touch.clientX; this.pointerPos.y = touch.clientY; }
    });

    // --- å…¨å±€äº‹ä»¶ç›£è½èˆ‡åˆå§‹åŒ– ---
    // ... (èˆ‡ä¹‹å‰ç›¸åŒ)
    
    // --- æœ€çµ‚åˆå§‹åŒ– ---
    Leaderboard.init();
    AudioManager.preload();
    Game.init();
    </script>
</body>
</html>